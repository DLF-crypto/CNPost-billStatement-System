<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>产品信息管理 - 中邮账单管理系统</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- 头部导航 -->
        <header class="dashboard-header">
            <div class="header-left"></div>
            
            <div class="header-center">
                <h1>
                    <i class="fas fa-file-invoice-dollar"></i>
                    中邮账单管理系统
                    <small style="display: block; font-size: 14px; font-weight: 300; margin-top: 5px;">China Post Bill Management System</small>
                </h1>
            </div>
            
            <div class="header-right">
                <div class="user-info">
                    <div class="user-dropdown">
                        <div class="user-button">
                            <i class="fas fa-user-circle"></i>
                            <span>{{ username }}</span>
                        </div>
                        <div class="dropdown-content">
                            <a href="#" onclick="showChangePasswordModal(); event.stopPropagation(); return false;">
                                <i class="fas fa-key"></i>
                                修改密码
                            </a>
                            <a href="{{ url_for('logout') }}">
                                <i class="fas fa-sign-out-alt"></i>
                                退出登录
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- 主要布局容器 -->
        <div class="main-container">
            <!-- 左侧菜单栏 -->
            <aside class="sidebar">
                <nav class="sidebar-nav">
                    <ul class="nav-menu">
                        {% if 'dashboard' in permissions %}
                        <li class="nav-item">
                            <a href="{{ url_for('dashboard') }}" class="nav-link">
                                <i class="fas fa-tachometer-alt"></i>
                                <span>仪表盘</span>
                            </a>
                        </li>
                        {% endif %}
                        
                        {% if 'employees' in permissions or 'roles' in permissions or 'products' in permissions %}
                        <li class="nav-item has-submenu">
                            <a href="#" class="nav-link" onclick="toggleSubmenu(this)">
                                <i class="fas fa-database"></i>
                                <span>基础资料管理</span>
                                <i class="fas fa-chevron-right submenu-arrow"></i>
                            </a>
                            <ul class="submenu">
                                {% if 'employees' in permissions %}
                                <li><a href="{{ url_for('employees') }}" class="submenu-link"><i class="fas fa-users"></i>员工管理</a></li>
                                {% endif %}
                                {% if 'roles' in permissions %}
                                <li><a href="{{ url_for('roles') }}" class="submenu-link"><i class="fas fa-user-tag"></i>角色管理</a></li>
                                {% endif %}
                                {% if 'products' in permissions %}
                                <li><a href="{{ url_for('products') }}" class="submenu-link active"><i class="fas fa-box"></i>产品信息管理</a></li>
                                {% endif %}
                                <li><a href="{{ url_for('bill_info') }}" class="submenu-link"><i class="fas fa-file-invoice"></i>账单信息管理</a></li>
                            </ul>
                        </li>
                        {% endif %}
                        
                        {% if 'mail_data' in permissions %}
                        <li class="nav-item">
                            <a href="{{ url_for('mail_data') }}" class="nav-link">
                                <i class="fas fa-envelope"></i>
                                <span>邮件数据管理</span>
                            </a>
                        </li>
                        {% endif %}
                        
                        {% if 'bill_management' in permissions %}
                        <li class="nav-item">
                            <a href="{{ url_for('bill_management') }}" class="nav-link">
                                <i class="fas fa-calculator"></i>
                                <span>账单管理</span>
                            </a>
                        </li>
                        {% endif %}
                        
                        {% if 'reports' in permissions %}
                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="fas fa-chart-bar"></i>
                                <span>分析报表</span>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
            </aside>

            <!-- 主要内容 -->
            <main class="main-content">
                <div class="content-header">
                    <h2><i class="fas fa-box"></i> 产品信息管理</h2>
                </div>

                <!-- 查询功能 -->
                <div class="search-section" style="margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                    <div class="search-form" style="display: flex; align-items: center; gap: 15px;">
                        <label for="product-search" style="font-weight: 500; color: #495057; white-space: nowrap;">
                            <i class="fas fa-search"></i> 产品查询:
                        </label>
                        <input type="text" 
                               id="product-search" 
                               placeholder="输入产品识别符1或产品名称" 
                               style="flex: 1; max-width: 300px; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px;"
                               oninput="filterProducts(this.value)">
                        <button type="button" 
                                class="btn btn-secondary" 
                                onclick="clearProductSearch()" 
                                style="padding: 8px 16px; font-size: 14px;">
                            <i class="fas fa-times"></i> 清空
                        </button>
                    </div>
                </div>

                <!-- 功能按钮 -->
                <div class="action-buttons">
                    <button class="btn btn-success" onclick="showImportModal()">
                        <i class="fas fa-file-excel"></i> 导入Excel
                    </button>
                    <button class="btn btn-primary" onclick="showAddProductModal()">
                        <i class="fas fa-plus"></i> 新增产品
                    </button>
                </div>

                <!-- 产品列表 -->
                <div class="product-list bill-list">
                    <div class="table-container">
                        <table class="employee-table">
                            <thead>
                                <tr>
                                    <th>序号</th>
                                    <th>产品识别符1</th>
                                    <th>产品识别符2</th>
                                    <th>产品结算代码</th>
                                    <th>产品中文名称</th>
                                    <th>创建时间</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="productTableBody">
                                <!-- 数据将通过JavaScript动态加载 -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- 分页导航栏 -->
                    <div class="pagination-container">
                        <div class="pagination-info">
                            <span id="productPaginationInfo">显示第 1-15 条，共 0 条记录</span>
                        </div>
                        <div class="pagination">
                            <button class="pagination-btn" id="productFirstPageBtn" onclick="goToProductPage(1)" disabled>
                                <i class="fas fa-angle-double-left"></i> 首页
                            </button>
                            <button class="pagination-btn" id="productPrevPageBtn" onclick="goToPrevProductPage()" disabled>
                                <i class="fas fa-angle-left"></i> 上一页
                            </button>
                            
                            <div class="page-numbers" id="productPageNumbers">
                                <!-- 页码按钮将通过JavaScript动态生成 -->
                            </div>
                            
                            <button class="pagination-btn" id="productNextPageBtn" onclick="goToNextProductPage()">
                                下一页 <i class="fas fa-angle-right"></i>
                            </button>
                            <button class="pagination-btn" id="productLastPageBtn" onclick="goToLastProductPage()">
                                末页 <i class="fas fa-angle-double-right"></i>
                            </button>
                        </div>
                        
                        <div class="page-size-selector">
                            <label for="productPageSizeSelect">每页显示：</label>
                            <select id="productPageSizeSelect" onchange="changeProductPageSize()">
                                <option value="15" selected>15条</option>
                                <option value="30">30条</option>
                                <option value="50">50条</option>
                                <option value="100">100条</option>
                            </select>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- 新增产品模态框 -->
    <div id="addProductModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-plus"></i> 新增产品</h3>
                <span class="close" onclick="closeAddProductModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="addProductForm">
                    <div class="form-group">
                        <label for="productIdentifier1">产品识别符1 <span class="required">*</span></label>
                        <input type="text" id="productIdentifier1" name="product_identifier1" required>
                    </div>
                    <div class="form-group">
                        <label for="productIdentifier2">产品识别符2</label>
                        <input type="text" id="productIdentifier2" name="product_identifier2">
                    </div>
                    <div class="form-group">
                        <label for="productSettleCode">产品结算代码 <span class="required">*</span></label>
                        <input type="text" id="productSettleCode" name="product_settle_code" required>
                    </div>
                    <div class="form-group">
                        <label for="productName">产品中文名称 <span class="required">*</span></label>
                        <input type="text" id="productName" name="product_name" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeAddProductModal()">取消</button>
                <button type="button" class="btn btn-primary" onclick="addProduct()">确定</button>
            </div>
        </div>
    </div>

    <!-- 编辑产品模态框 -->
    <div id="editProductModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> 编辑产品</h3>
                <span class="close" onclick="closeEditProductModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editProductForm">
                    <input type="hidden" id="editProductId" name="product_id">
                    <div class="form-group">
                        <label for="editProductIdentifier1">产品识别符1 <span class="required">*</span></label>
                        <input type="text" id="editProductIdentifier1" name="product_identifier1" required>
                    </div>
                    <div class="form-group">
                        <label for="editProductIdentifier2">产品识别符2</label>
                        <input type="text" id="editProductIdentifier2" name="product_identifier2">
                    </div>
                    <div class="form-group">
                        <label for="editProductSettleCode">产品结算代码 <span class="required">*</span></label>
                        <input type="text" id="editProductSettleCode" name="product_settle_code" required>
                    </div>
                    <div class="form-group">
                        <label for="editProductName">产品中文名称 <span class="required">*</span></label>
                        <input type="text" id="editProductName" name="product_name" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeEditProductModal()">取消</button>
                <button type="button" class="btn btn-primary" onclick="updateProduct()">确定</button>
            </div>
        </div>
    </div>

    <script>
        // 显示新增产品模态框
        function showAddProductModal() {
            document.getElementById('addProductModal').style.display = 'block';
        }

        // 关闭新增产品模态框
        function closeAddProductModal() {
            document.getElementById('addProductModal').style.display = 'none';
            document.getElementById('addProductForm').reset();
        }

        // 显示编辑产品模态框
        function showEditProductModal() {
            document.getElementById('editProductModal').style.display = 'block';
        }

        // 关闭编辑产品模态框
        function closeEditProductModal() {
            document.getElementById('editProductModal').style.display = 'none';
            document.getElementById('editProductForm').reset();
        }

        // 新增产品
        function addProduct() {
            const form = document.getElementById('addProductForm');
            
            // 验证必填项
            const identifier1 = document.getElementById('productIdentifier1').value.trim();
            const settleCode = document.getElementById('productSettleCode').value.trim();
            const productName = document.getElementById('productName').value.trim();
            const identifier2 = document.getElementById('productIdentifier2').value.trim();
            
            if (!identifier1 || !settleCode || !productName) {
                alert('产品识别符1、产品结算代码、产品中文名称为必填项');
                return;
            }
            
            // 检查产品识别符1是否重复
            fetch(`/check_product_identifier1/${encodeURIComponent(identifier1)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.exists) {
                        // 产品识别符1重复，检查产品识别符2
                        if (!identifier2) {
                            alert('产品识别符1已存在，产品识别符2不能为空');
                            return;
                        }
                        
                        // 检查组合是否重复
                        fetch(`/check_product_identifiers/${encodeURIComponent(identifier1)}/${encodeURIComponent(identifier2)}`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.exists) {
                                    alert('相同产品识别符1下的产品识别符2已存在');
                                    return;
                                }
                                // 验证通过，提交表单
                                submitAddProduct();
                            })
                            .catch(error => {
                                console.error('验证失败:', error);
                                alert('验证失败，请重试');
                            });
                    } else {
                        // 验证通过，提交表单
                        submitAddProduct();
                    }
                })
                .catch(error => {
                    console.error('验证失败:', error);
                    alert('验证失败，请重试');
                });
            
            function submitAddProduct() {
                const formData = new FormData(form);
                
                fetch('/add_product', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('产品添加成功！');
                        closeAddProductModal();
                        loadProductData();
                    } else {
                        alert('添加失败：' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('添加失败，请重试！');
                });
            }
        }

        // 编辑产品
        function editProduct(productId) {
            fetch(`/get_product/${productId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const product = data.product;
                    document.getElementById('editProductId').value = product.product_id;
                    document.getElementById('editProductIdentifier1').value = product.product_identifier1;
                    document.getElementById('editProductIdentifier2').value = product.product_identifier2;
                    document.getElementById('editProductSettleCode').value = product.product_settle_code;
                    document.getElementById('editProductName').value = product.product_name;
                    showEditProductModal();
                } else {
                    alert('获取产品信息失败：' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('获取产品信息失败，请重试！');
            });
        }

        // 更新产品
        function updateProduct() {
            const form = document.getElementById('editProductForm');
            const productId = document.getElementById('editProductId').value;
            
            // 验证必填项
            const identifier1 = document.getElementById('editProductIdentifier1').value.trim();
            const settleCode = document.getElementById('editProductSettleCode').value.trim();
            const productName = document.getElementById('editProductName').value.trim();
            const identifier2 = document.getElementById('editProductIdentifier2').value.trim();
            
            if (!identifier1 || !settleCode || !productName) {
                alert('产品识别符1、产品结算代码、产品中文名称为必填项！');
                return;
            }
            
            // 检查产品识别符1是否重复（排除当前产品）
            fetch(`/check_product_identifier1_exclude/${encodeURIComponent(identifier1)}/${productId}`)
            .then(response => response.json())
            .then(data => {
                if (data.exists) {
                    if (!identifier2) {
                        alert('产品识别符1已存在，产品识别符2不能为空！');
                        return;
                    }
                    // 检查相同identifier1下identifier2是否重复（排除当前产品）
                    fetch(`/check_product_identifiers_exclude/${encodeURIComponent(identifier1)}/${encodeURIComponent(identifier2)}/${productId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.exists) {
                            alert('相同产品识别符1下的产品识别符2已存在！');
                            return;
                        }
                        submitUpdateProduct();
                    })
                    .catch(error => {
                        console.error('验证失败:', error);
                        alert('验证失败，请重试');
                    });
                } else {
                    submitUpdateProduct();
                }
            })
            .catch(error => {
                console.error('验证失败:', error);
                alert('验证失败，请重试');
            });
            
            function submitUpdateProduct() {
                const formData = new FormData(form);
                
                fetch(`/update_product/${productId}`, {
                    method: 'PUT',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('产品更新成功！');
                        closeEditProductModal();
                        loadProductData();
                    } else {
                        alert('更新失败：' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('更新失败，请重试！');
                });
            }
        }

        // 删除产品
        function deleteProduct(productId) {
            if (confirm('确定要删除这个产品吗？')) {
                fetch(`/delete_product/${productId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('产品删除成功！');
                        loadProductData();
                    } else {
                        alert('删除失败：' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('删除失败，请重试！');
                });
            }
        }

        // 子菜单切换功能
        function toggleSubmenu(element) {
            const submenu = element.nextElementSibling;
            const arrow = element.querySelector('.submenu-arrow');
            
            if (submenu.style.maxHeight && submenu.style.maxHeight !== '0px') {
                submenu.style.maxHeight = '0px';
                arrow.classList.remove('fa-chevron-down');
                arrow.classList.add('fa-chevron-right');
                localStorage.setItem('submenuExpanded', 'false');
            } else {
                submenu.style.maxHeight = submenu.scrollHeight + 'px';
                arrow.classList.remove('fa-chevron-right');
                arrow.classList.add('fa-chevron-down');
                localStorage.setItem('submenuExpanded', 'true');
            }
        }
        
        // 分页相关变量
        let currentProductPage = 1;
        let productPageSize = 15;
        let totalProductPages = 1;
        let allProducts = [];
        let filteredProducts = [];
        let currentSearchTerm = '';
        
        // 页面加载时检查菜单状态并加载产品数据
        document.addEventListener('DOMContentLoaded', function() {
            const submenu = document.querySelector('.submenu');
            const arrow = document.querySelector('.submenu-arrow');
            const isExpanded = localStorage.getItem('submenuExpanded') === 'true';
            
            if (isExpanded && submenu) {
                submenu.style.maxHeight = submenu.scrollHeight + 'px';
                if (arrow) {
                    arrow.classList.remove('fa-chevron-right');
                    arrow.classList.add('fa-chevron-down');
                }
            } else if (submenu) {
                submenu.style.maxHeight = '0px';
                if (arrow) {
                    arrow.classList.remove('fa-chevron-down');
                    arrow.classList.add('fa-chevron-right');
                }
            }
            
            // 二级菜单点击时设置展开状态
            const submenuLinks = document.querySelectorAll('.submenu-link');
            submenuLinks.forEach(function(link) {
                link.addEventListener('click', function(e) {
                    localStorage.setItem('submenuExpanded', 'true');
                    e.stopPropagation();
                });
            });
            
            // 加载产品数据
            loadProductData();
        });
        
        // 加载产品数据
        function loadProductData() {
            fetch('/get_products')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    allProducts = data.products;
                    filteredProducts = [...allProducts];
                    updateProductDisplay();
                } else {
                    console.error('加载产品数据失败:', data.message);
                }
            })
            .catch(error => {
                console.error('加载产品数据失败:', error);
            });
        }
        
        // 更新产品显示
        function updateProductDisplay() {
            const startIndex = (currentProductPage - 1) * productPageSize;
            const endIndex = startIndex + productPageSize;
            const pageProducts = filteredProducts.slice(startIndex, endIndex);
            
            const tbody = document.getElementById('productTableBody');
            tbody.innerHTML = '';
            
            pageProducts.forEach((product, index) => {
                const row = document.createElement('tr');
                const globalIndex = startIndex + index + 1;
                
                row.innerHTML = `
                    <td>${globalIndex}</td>
                    <td>${product.product_identifier1 || ''}</td>
                    <td>${product.product_identifier2 || ''}</td>
                    <td>${product.product_settle_code || ''}</td>
                    <td>${product.product_name || ''}</td>
                    <td>${product.created_at ? new Date(product.created_at).toLocaleString('zh-CN') : '-'}</td>
                    <td class="table-actions">
                        <button class="btn btn-sm btn-info" onclick="editProduct('${product.product_id}')" title="编辑">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteProduct('${product.product_id}')" title="删除">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            updateProductPagination();
        }
        
        // 更新分页信息
        function updateProductPagination() {
            totalProductPages = Math.ceil(filteredProducts.length / productPageSize);
            
            // 更新分页信息文本
            const startIndex = (currentProductPage - 1) * productPageSize + 1;
            const endIndex = Math.min(currentProductPage * productPageSize, filteredProducts.length);
            document.getElementById('productPaginationInfo').textContent = 
                `显示第 ${startIndex}-${endIndex} 条，共 ${filteredProducts.length} 条记录`;
            
            // 更新分页按钮状态
            document.getElementById('productFirstPageBtn').disabled = currentProductPage === 1;
            document.getElementById('productPrevPageBtn').disabled = currentProductPage === 1;
            document.getElementById('productNextPageBtn').disabled = currentProductPage === totalProductPages || totalProductPages === 0;
            document.getElementById('productLastPageBtn').disabled = currentProductPage === totalProductPages || totalProductPages === 0;
            
            // 生成页码按钮
            generateProductPageNumbers();
        }
        
        // 生成页码按钮
        function generateProductPageNumbers() {
            const pageNumbersContainer = document.getElementById('productPageNumbers');
            pageNumbersContainer.innerHTML = '';
            
            if (totalProductPages <= 1) return;
            
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentProductPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalProductPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `pagination-btn ${i === currentProductPage ? 'active' : ''}`;
                pageBtn.textContent = i;
                pageBtn.onclick = () => goToProductPage(i);
                pageNumbersContainer.appendChild(pageBtn);
            }
        }
        
        // 分页控制函数
        function goToProductPage(page) {
            if (page >= 1 && page <= totalProductPages) {
                currentProductPage = page;
                updateProductDisplay();
            }
        }
        
        function goToPrevProductPage() {
            if (currentProductPage > 1) {
                currentProductPage--;
                updateProductDisplay();
            }
        }
        
        function goToNextProductPage() {
            if (currentProductPage < totalProductPages) {
                currentProductPage++;
                updateProductDisplay();
            }
        }
        
        function goToLastProductPage() {
            if (totalProductPages > 0) {
                currentProductPage = totalProductPages;
                updateProductDisplay();
            }
        }
        
        function changeProductPageSize() {
            const select = document.getElementById('productPageSizeSelect');
            productPageSize = parseInt(select.value);
            currentProductPage = 1;
            updateProductDisplay();
        }
        
        // 搜索功能
        function filterProducts(searchTerm) {
            currentSearchTerm = searchTerm.toLowerCase().trim();
            
            if (currentSearchTerm === '') {
                filteredProducts = [...allProducts];
            } else {
                filteredProducts = allProducts.filter(product => {
                    return (product.product_identifier1 && product.product_identifier1.toLowerCase().includes(currentSearchTerm)) ||
                           (product.product_name && product.product_name.toLowerCase().includes(currentSearchTerm));
                });
            }
            
            currentProductPage = 1;
            updateProductDisplay();
        }
        
        function clearProductSearch() {
            document.getElementById('product-search').value = '';
            filterProducts('');
        }
        
        // 用户下拉菜单交互
        const userDropdown = document.querySelector('.user-dropdown');
        const userButton = document.querySelector('.user-button');
        const dropdownContent = document.querySelector('.dropdown-content');
        
        if (userDropdown && userButton && dropdownContent) {
            let isDropdownOpen = false;
            let mouseLeaveTimer = null;
            
            // 点击用户按钮切换下拉菜单
            userButton.addEventListener('click', function(e) {
                e.stopPropagation();
                isDropdownOpen = !isDropdownOpen;
                dropdownContent.classList.toggle('show', isDropdownOpen);
                // 清除可能存在的延时关闭
                if (mouseLeaveTimer) {
                    clearTimeout(mouseLeaveTimer);
                    mouseLeaveTimer = null;
                }
            });
            
            // 鼠标进入用户按钮区域时显示下拉菜单
            userButton.addEventListener('mouseenter', function() {
                if (!isDropdownOpen) {
                    isDropdownOpen = true;
                    dropdownContent.classList.add('show');
                }
                // 清除延时关闭
                if (mouseLeaveTimer) {
                    clearTimeout(mouseLeaveTimer);
                    mouseLeaveTimer = null;
                }
            });
            
            // 鼠标进入下拉内容区域时保持显示
            dropdownContent.addEventListener('mouseenter', function() {
                // 清除延时关闭
                if (mouseLeaveTimer) {
                    clearTimeout(mouseLeaveTimer);
                    mouseLeaveTimer = null;
                }
            });
            
            // 鼠标离开用户按钮时设置延时关闭
            userButton.addEventListener('mouseleave', function() {
                mouseLeaveTimer = setTimeout(function() {
                    isDropdownOpen = false;
                    dropdownContent.classList.remove('show');
                }, 200); // 200ms延时，给用户时间移动到下拉框
            });
            
            // 鼠标离开下拉内容区域时关闭
            dropdownContent.addEventListener('mouseleave', function() {
                mouseLeaveTimer = setTimeout(function() {
                    isDropdownOpen = false;
                    dropdownContent.classList.remove('show');
                }, 200);
            });
            
            // 点击页面其他地方时隐藏下拉菜单
            document.addEventListener('click', function(e) {
                if (!userDropdown.contains(e.target)) {
                    isDropdownOpen = false;
                    dropdownContent.classList.remove('show');
                    if (mouseLeaveTimer) {
                        clearTimeout(mouseLeaveTimer);
                        mouseLeaveTimer = null;
                    }
                }
            });
        }

        // 点击模态框外部关闭
        window.onclick = function(event) {
            const addModal = document.getElementById('addProductModal');
            const editModal = document.getElementById('editProductModal');
            
            if (event.target == addModal) {
                closeAddProductModal();
            }
            if (event.target == editModal) {
                closeEditProductModal();
            }
        }
        
        // Excel导入功能
        function showImportModal() {
            document.getElementById('importModal').style.display = 'block';
        }
        
        function closeImportModal() {
            document.getElementById('importModal').style.display = 'none';
            document.getElementById('importForm').reset();
        }
        
        function importExcel() {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('请选择要导入的Excel文件！');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            fetch('/import_products', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.message) {
                        alert(data.message);
                    } else {
                        alert(`导入成功！共导入 ${data.count} 条产品信息。`);
                    }
                    closeImportModal();
                    loadProductData();
                } else {
                    alert('导入失败：' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('导入失败，请重试！');
            });
        }
    </script>
    
    <!-- Excel导入模态框 -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-file-excel"></i> 导入Excel</h3>
                <span class="close" onclick="closeImportModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="importForm">
                    <div class="form-group">
                        <label for="excelFile">选择Excel文件：</label>
                        <input type="file" id="excelFile" name="file" accept=".xlsx,.xls" required>
                    </div>
                    <div class="import-info">
                        <h4>导入说明：</h4>
                        <ul>
                            <li>Excel文件应包含以下列：产品识别符1、产品识别符2、产品结算代码、产品中文名称</li>
                            <li>产品识别符1、产品结算代码、产品中文名称为必填项</li>
                            <li>如果产品识别符1重复，产品识别符2必须不同且不能为空</li>
                            <li>支持.xlsx和.xls格式文件</li>
                        </ul>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeImportModal()">取消</button>
                <button type="button" class="btn btn-success" onclick="importExcel()">导入</button>
            </div>
        </div>
    </div>
</body>
</html>