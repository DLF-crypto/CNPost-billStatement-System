<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>产品信息管理 - 中邮账单管理系统</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- 头部导航 -->
        <header class="dashboard-header">
            <div class="header-left"></div>
            
            <div class="header-center">
                <h1>
                    <i class="fas fa-file-invoice-dollar"></i>
                    中邮账单管理系统
                    <small style="display: block; font-size: 14px; font-weight: 300; margin-top: 5px;">China Post Bill Management System</small>
                </h1>
            </div>
            
            <div class="header-right">
                <div class="user-info">
                    <div class="user-dropdown">
                        <div class="user-button">
                            <i class="fas fa-user-circle"></i>
                            <span>{{ username }}</span>
                        </div>
                        <div class="dropdown-content">
                            <a href="#" onclick="showChangePasswordModal(); event.stopPropagation(); return false;">
                                <i class="fas fa-key"></i>
                                修改密码
                            </a>
                            <a href="{{ url_for('logout') }}">
                                <i class="fas fa-sign-out-alt"></i>
                                退出登录
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- 主要布局容器 -->
        <div class="main-container">
            <!-- 左侧菜单栏 -->
            <aside class="sidebar">
                <nav class="sidebar-nav">
                    <ul class="nav-menu">
                        {% if 'dashboard' in permissions %}
                        <li class="nav-item">
                            <a href="{{ url_for('dashboard') }}" class="nav-link">
                                <i class="fas fa-tachometer-alt"></i>
                                <span>仪表盘</span>
                            </a>
                        </li>
                        {% endif %}
                        
                        {% if 'employees' in permissions or 'roles' in permissions or 'products' in permissions %}
                        <li class="nav-item has-submenu">
                            <a href="#" class="nav-link" onclick="toggleSubmenu(this)">
                                <i class="fas fa-database"></i>
                                <span>基础资料管理</span>
                                <i class="fas fa-chevron-right submenu-arrow"></i>
                            </a>
                            <ul class="submenu">
                                {% if 'employees' in permissions %}
                                <li><a href="{{ url_for('employees') }}" class="submenu-link"><i class="fas fa-users"></i>员工管理</a></li>
                                {% endif %}
                                {% if 'roles' in permissions %}
                                <li><a href="{{ url_for('roles') }}" class="submenu-link"><i class="fas fa-user-tag"></i>角色管理</a></li>
                                {% endif %}
                                {% if 'products' in permissions %}
                                <li><a href="{{ url_for('products') }}" class="submenu-link active"><i class="fas fa-box"></i>产品信息管理</a></li>
                                {% endif %}
                                <li><a href="{{ url_for('bill_info') }}" class="submenu-link"><i class="fas fa-file-invoice"></i>账单信息管理</a></li>
                            </ul>
                        </li>
                        {% endif %}
                        
                        {% if 'mail_data' in permissions %}
                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="fas fa-envelope"></i>
                                <span>邮件数据管理</span>
                            </a>
                        </li>
                        {% endif %}
                        
                        {% if 'reports' in permissions %}
                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="fas fa-chart-bar"></i>
                                <span>分析报表</span>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
            </aside>

            <!-- 主要内容 -->
            <main class="main-content">
                <div class="content-header">
                    <h2><i class="fas fa-box"></i> 产品信息管理</h2>
                    <button class="btn btn-primary" onclick="showAddProductModal()">
                        <i class="fas fa-plus"></i> 新增产品
                    </button>
                </div>

                <!-- 产品列表 -->
                <div class="product-list">
                    <div class="table-container">
                        <table class="product-table">
                            <thead>
                                <tr>
                                    <th>产品ID</th>
                                    <th>产品代码</th>
                                    <th>产品名称</th>
                                    <th>产品类型</th>
                                    <th>单价</th>
                                    <th>状态</th>
                                    <th>创建时间</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="productTableBody">
                                {% for product in products %}
                                <tr>
                                    <td>{{ product.product_id }}</td>
                                    <td>{{ product.product_code }}</td>
                                    <td>{{ product.product_name }}</td>
                                    <td>{{ product.product_type }}</td>
                                    <td>¥{{ "%.2f"|format(product.unit_price) }}</td>
                                    <td>
                                        <span class="status-badge {{ 'active' if product.status == '启用' else 'inactive' }}">
                                            {{ product.status }}
                                        </span>
                                    </td>
                                    <td>{{ product.created_at.strftime('%Y-%m-%d %H:%M') if product.created_at else '-' }}</td>
                                    <td class="action-buttons">
                                        <button class="btn btn-sm btn-info" onclick="editProduct('{{ product.product_id }}')" title="编辑">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteProduct('{{ product.product_id }}')" title="删除">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- 新增产品模态框 -->
    <div id="addProductModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-plus"></i> 新增产品</h3>
                <span class="close" onclick="closeAddProductModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="addProductForm">
                    <div class="form-group">
                        <label for="productCode">产品代码 <span class="required">*</span></label>
                        <input type="text" id="productCode" name="product_code" required>
                    </div>
                    <div class="form-group">
                        <label for="productName">产品名称 <span class="required">*</span></label>
                        <input type="text" id="productName" name="product_name" required>
                    </div>
                    <div class="form-group">
                        <label for="productType">产品类型 <span class="required">*</span></label>
                        <select id="productType" name="product_type" required>
                            <option value="">请选择产品类型</option>
                            <option value="邮件">邮件</option>
                            <option value="包裹">包裹</option>
                            <option value="快递">快递</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="unitPrice">单价 <span class="required">*</span></label>
                        <input type="number" id="unitPrice" name="unit_price" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="productStatus">状态</label>
                        <select id="productStatus" name="status">
                            <option value="启用">启用</option>
                            <option value="禁用">禁用</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="description">产品描述</label>
                        <textarea id="description" name="description" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeAddProductModal()">取消</button>
                <button type="button" class="btn btn-primary" onclick="addProduct()">确定</button>
            </div>
        </div>
    </div>

    <!-- 编辑产品模态框 -->
    <div id="editProductModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> 编辑产品</h3>
                <span class="close" onclick="closeEditProductModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editProductForm">
                    <input type="hidden" id="editProductId" name="product_id">
                    <div class="form-group">
                        <label for="editProductCode">产品代码 <span class="required">*</span></label>
                        <input type="text" id="editProductCode" name="product_code" required>
                    </div>
                    <div class="form-group">
                        <label for="editProductName">产品名称 <span class="required">*</span></label>
                        <input type="text" id="editProductName" name="product_name" required>
                    </div>
                    <div class="form-group">
                        <label for="editProductType">产品类型 <span class="required">*</span></label>
                        <select id="editProductType" name="product_type" required>
                            <option value="">请选择产品类型</option>
                            <option value="邮件">邮件</option>
                            <option value="包裹">包裹</option>
                            <option value="快递">快递</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editUnitPrice">单价 <span class="required">*</span></label>
                        <input type="number" id="editUnitPrice" name="unit_price" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="editProductStatus">状态</label>
                        <select id="editProductStatus" name="status">
                            <option value="启用">启用</option>
                            <option value="禁用">禁用</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editDescription">产品描述</label>
                        <textarea id="editDescription" name="description" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeEditProductModal()">取消</button>
                <button type="button" class="btn btn-primary" onclick="updateProduct()">确定</button>
            </div>
        </div>
    </div>

    <script>
        // 显示新增产品模态框
        function showAddProductModal() {
            document.getElementById('addProductModal').style.display = 'block';
        }

        // 关闭新增产品模态框
        function closeAddProductModal() {
            document.getElementById('addProductModal').style.display = 'none';
            document.getElementById('addProductForm').reset();
        }

        // 显示编辑产品模态框
        function showEditProductModal() {
            document.getElementById('editProductModal').style.display = 'block';
        }

        // 关闭编辑产品模态框
        function closeEditProductModal() {
            document.getElementById('editProductModal').style.display = 'none';
            document.getElementById('editProductForm').reset();
        }

        // 新增产品
        function addProduct() {
            const form = document.getElementById('addProductForm');
            const formData = new FormData(form);
            
            fetch('/add_product', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('产品添加成功！');
                    location.reload();
                } else {
                    alert('添加失败：' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('添加失败，请重试！');
            });
        }

        // 编辑产品
        function editProduct(productId) {
            fetch(`/get_product/${productId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const product = data.product;
                    document.getElementById('editProductId').value = product.product_id;
                    document.getElementById('editProductCode').value = product.product_code;
                    document.getElementById('editProductName').value = product.product_name;
                    document.getElementById('editProductType').value = product.product_type;
                    document.getElementById('editUnitPrice').value = product.unit_price;
                    document.getElementById('editProductStatus').value = product.status;
                    document.getElementById('editDescription').value = product.description || '';
                    showEditProductModal();
                } else {
                    alert('获取产品信息失败：' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('获取产品信息失败，请重试！');
            });
        }

        // 更新产品
        function updateProduct() {
            const form = document.getElementById('editProductForm');
            const formData = new FormData(form);
            const productId = document.getElementById('editProductId').value;
            
            fetch(`/update_product/${productId}`, {
                method: 'PUT',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('产品更新成功！');
                    location.reload();
                } else {
                    alert('更新失败：' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('更新失败，请重试！');
            });
        }

        // 删除产品
        function deleteProduct(productId) {
            if (confirm('确定要删除这个产品吗？')) {
                fetch(`/delete_product/${productId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('产品删除成功！');
                        location.reload();
                    } else {
                        alert('删除失败：' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('删除失败，请重试！');
                });
            }
        }

        // 子菜单切换功能
        function toggleSubmenu(element) {
            const submenu = element.nextElementSibling;
            const arrow = element.querySelector('.submenu-arrow');
            
            if (submenu.style.maxHeight && submenu.style.maxHeight !== '0px') {
                submenu.style.maxHeight = '0px';
                arrow.classList.remove('fa-chevron-down');
                arrow.classList.add('fa-chevron-right');
                localStorage.setItem('submenuExpanded', 'false');
            } else {
                submenu.style.maxHeight = submenu.scrollHeight + 'px';
                arrow.classList.remove('fa-chevron-right');
                arrow.classList.add('fa-chevron-down');
                localStorage.setItem('submenuExpanded', 'true');
            }
        }
        
        // 页面加载时检查菜单状态
        document.addEventListener('DOMContentLoaded', function() {
            const submenu = document.querySelector('.submenu');
            const arrow = document.querySelector('.submenu-arrow');
            const isExpanded = localStorage.getItem('submenuExpanded') === 'true';
            
            if (isExpanded && submenu) {
                submenu.style.maxHeight = submenu.scrollHeight + 'px';
                if (arrow) {
                    arrow.classList.remove('fa-chevron-right');
                    arrow.classList.add('fa-chevron-down');
                }
            } else if (submenu) {
                submenu.style.maxHeight = '0px';
                if (arrow) {
                    arrow.classList.remove('fa-chevron-down');
                    arrow.classList.add('fa-chevron-right');
                }
            }
            
            // 二级菜单点击时设置展开状态
            const submenuLinks = document.querySelectorAll('.submenu-link');
            submenuLinks.forEach(function(link) {
                link.addEventListener('click', function(e) {
                    localStorage.setItem('submenuExpanded', 'true');
                    e.stopPropagation();
                });
            });
        });
        
        // 用户下拉菜单交互
        const userDropdown = document.querySelector('.user-dropdown');
        const userButton = document.querySelector('.user-button');
        const dropdownContent = document.querySelector('.dropdown-content');
        
        if (userDropdown && userButton && dropdownContent) {
            let isDropdownOpen = false;
            let mouseLeaveTimer = null;
            
            // 点击用户按钮切换下拉菜单
            userButton.addEventListener('click', function(e) {
                e.stopPropagation();
                isDropdownOpen = !isDropdownOpen;
                dropdownContent.classList.toggle('show', isDropdownOpen);
                // 清除可能存在的延时关闭
                if (mouseLeaveTimer) {
                    clearTimeout(mouseLeaveTimer);
                    mouseLeaveTimer = null;
                }
            });
            
            // 鼠标进入用户按钮区域时显示下拉菜单
            userButton.addEventListener('mouseenter', function() {
                if (!isDropdownOpen) {
                    isDropdownOpen = true;
                    dropdownContent.classList.add('show');
                }
                // 清除延时关闭
                if (mouseLeaveTimer) {
                    clearTimeout(mouseLeaveTimer);
                    mouseLeaveTimer = null;
                }
            });
            
            // 鼠标进入下拉内容区域时保持显示
            dropdownContent.addEventListener('mouseenter', function() {
                // 清除延时关闭
                if (mouseLeaveTimer) {
                    clearTimeout(mouseLeaveTimer);
                    mouseLeaveTimer = null;
                }
            });
            
            // 鼠标离开用户按钮时设置延时关闭
            userButton.addEventListener('mouseleave', function() {
                mouseLeaveTimer = setTimeout(function() {
                    isDropdownOpen = false;
                    dropdownContent.classList.remove('show');
                }, 200); // 200ms延时，给用户时间移动到下拉框
            });
            
            // 鼠标离开下拉内容区域时关闭
            dropdownContent.addEventListener('mouseleave', function() {
                mouseLeaveTimer = setTimeout(function() {
                    isDropdownOpen = false;
                    dropdownContent.classList.remove('show');
                }, 200);
            });
            
            // 点击页面其他地方时隐藏下拉菜单
            document.addEventListener('click', function(e) {
                if (!userDropdown.contains(e.target)) {
                    isDropdownOpen = false;
                    dropdownContent.classList.remove('show');
                    if (mouseLeaveTimer) {
                        clearTimeout(mouseLeaveTimer);
                        mouseLeaveTimer = null;
                    }
                }
            });
        }

        // 点击模态框外部关闭
        window.onclick = function(event) {
            const addModal = document.getElementById('addProductModal');
            const editModal = document.getElementById('editProductModal');
            
            if (event.target == addModal) {
                closeAddProductModal();
            }
            if (event.target == editModal) {
                closeEditProductModal();
            }
        }
    </script>
</body>
</html>