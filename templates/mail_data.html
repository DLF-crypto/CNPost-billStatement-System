<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>邮件数据管理 - 中邮账单管理系统</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- 头部导航 -->
        <header class="dashboard-header">
            <div class="header-left"></div>
            
            <div class="header-center">
                <h1>
                    <i class="fas fa-file-invoice-dollar"></i>
                    中邮账单管理系统
                    <small style="display: block; font-size: 14px; font-weight: 300; margin-top: 5px;">China Post Bill Management System</small>
                </h1>
            </div>
            
            <div class="header-right">
                <div class="user-info">
                    <div class="user-dropdown">
                        <div class="user-button">
                            <i class="fas fa-user-circle"></i>
                            <span>{{ username }}</span>
                        </div>
                        <div class="dropdown-content">
                            <a href="#" onclick="showChangePasswordModal(); event.stopPropagation(); return false;">
                                <i class="fas fa-key"></i>
                                修改密码
                            </a>
                            <a href="{{ url_for('logout') }}">
                                <i class="fas fa-sign-out-alt"></i>
                                退出登录
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- 主要布局容器 -->
        <div class="main-container">
            <!-- 左侧菜单栏 -->
            <aside class="sidebar">
                <nav class="sidebar-nav">
                    <ul class="nav-menu">
                        {% if 'dashboard' in permissions %}
                        <li class="nav-item">
                            <a href="{{ url_for('dashboard') }}" class="nav-link">
                                <i class="fas fa-tachometer-alt"></i>
                                <span>仪表盘</span>
                            </a>
                        </li>
                        {% endif %}
                        
                        {% if 'employees' in permissions or 'roles' in permissions or 'products' in permissions %}
                        <li class="nav-item has-submenu">
                            <a href="#" class="nav-link" onclick="toggleSubmenu(this)">
                                <i class="fas fa-database"></i>
                                <span>基础资料管理</span>
                                <i class="fas fa-chevron-right submenu-arrow"></i>
                            </a>
                            <ul class="submenu">
                                {% if 'employees' in permissions %}
                                <li><a href="{{ url_for('employees') }}" class="submenu-link"><i class="fas fa-users"></i>员工管理</a></li>
                                {% endif %}
                                {% if 'roles' in permissions %}
                                <li><a href="{{ url_for('roles') }}" class="submenu-link"><i class="fas fa-user-tag"></i>角色管理</a></li>
                                {% endif %}
                                {% if 'products' in permissions %}
                                <li><a href="{{ url_for('products') }}" class="submenu-link"><i class="fas fa-box"></i>产品信息管理</a></li>
                                {% endif %}
                                <li><a href="{{ url_for('bill_info') }}" class="submenu-link"><i class="fas fa-file-invoice"></i>账单信息管理</a></li>
                            </ul>
                        </li>
                        {% endif %}
                        
                        {% if 'mail_data' in permissions %}
                        <li class="nav-item active">
                            <a href="{{ url_for('mail_data') }}" class="nav-link">
                                <i class="fas fa-envelope-open-text"></i>
                                <span>邮件数据管理</span>
                            </a>
                        </li>
                        {% endif %}
                        
                        {% if 'bill_management' in permissions %}
                        <li class="nav-item">
                            <a href="{{ url_for('bill_management') }}" class="nav-link">
                                <i class="fas fa-calculator"></i>
                                <span>账单管理</span>
                            </a>
                        </li>
                        {% endif %}
                        
                        {% if 'reports' in permissions %}
                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="fas fa-chart-bar"></i>
                                <span>分析报表</span>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
            </aside>

            <!-- 主内容区域 -->
            <main class="main-content">
                <div class="content-header">
                    <h2><i class="fas fa-envelope"></i> 邮件数据管理</h2>
                </div>

                <!-- 搜索和筛选区域 -->
                <div class="search-section">
                    <div class="search-form">
                        <!-- 第一行：总包号和到达地查询 -->
                        <div class="search-row">
                            <div class="search-group">
                                <label for="receptacleNoInput">总包号查询：</label>
                                <input type="text" id="receptacleNoInput" placeholder="请输入总包号" class="search-input">
                            </div>
                            <div class="search-group">
                                <label for="destInput">到达地查询：</label>
                                <input type="text" id="destInput" placeholder="请输入到达地" class="search-input">
                            </div>
                        </div>
                        
                        <!-- 第二行：时间查询 -->
                        <div class="search-row">
                            <div class="search-group">
                                <label for="timeTypeSelect">时间类型：</label>
                                <select id="timeTypeSelect" class="search-select">
                                    <option value="">请选择时间类型</option>
                                    <option value="recTime">接收时间</option>
                                    <option value="upliftTime">启运时间</option>
                                    <option value="arriveTime">到达时间</option>
                                    <option value="deliverTime">交邮时间</option>
                                </select>
                            </div>
                            <div class="search-group">
                                <label for="startDate">开始时间：</label>
                                <input type="date" id="startDate" class="search-input">
                            </div>
                            <div class="search-group">
                                <label for="endDate">结束时间：</label>
                                <input type="date" id="endDate" class="search-input">
                            </div>
                        </div>
                        
                        <!-- 第三行：操作按钮 -->
                        <div class="search-row">
                            <div class="search-buttons">
                                <button class="btn btn-primary" onclick="searchMailData()">
                                    <i class="fas fa-search"></i> 搜索
                                </button>
                                <button class="btn btn-secondary" onclick="clearSearch()">
                                    <i class="fas fa-times"></i> 清空
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Excel导入和删除按钮 -->
                <div class="action-buttons" style="margin-bottom: 20px; display: flex; gap: 10px;">
                    <button class="btn btn-success" onclick="showImportExcelModal()">
                        <i class="fas fa-file-excel"></i> Excel导入
                    </button>
                    <button class="btn btn-danger" onclick="deleteSelectedRows()" style="background-color: #dc3545; border-color: #dc3545;">
                        <i class="fas fa-trash"></i> 删除
                    </button>
                </div>

                <!-- 邮件数据列表 -->
                <div class="bill-list">
                    <div class="table-container" style="overflow-x: auto; max-width: 100%; border: 1px solid #d0d7de; border-radius: 6px;">
                        <table class="employee-table">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                                    <th>序号</th>
                                <th>邮件类型</th>
                                <th>邮件种类</th>
                                <th>总包号</th>
                                <th>始发局</th>
                                <th>寄达局</th>
                                <th>到达地</th>
                                <th>接收时间</th>
                                <th>启运时间</th>
                                <th>到达时间</th>
                                <th>交邮时间</th>
                                <th>收费路由</th>
                                <th>航班</th>
                                <th>重量</th>
                                <th>费率</th>
                                <th>金额</th>
                                <th>运能编码</th>
                            </tr>
                        </thead>
                        <tbody id="mailDataTableBody">
                            <!-- 数据通过JavaScript动态加载 -->
                        </tbody>
                    </table>
                    </div>
                </div>

                <!-- 分页导航 -->
                <div class="pagination-container">
                    <div class="pagination-left">
                        <div class="pagination-info">
                            <span id="paginationInfo">显示第 1-200 条，共 0 条记录</span>
                        </div>
                        <div class="pagination-size">
                            <label for="pageSizeSelect">每页显示：</label>
                            <select id="pageSizeSelect" onchange="changePageSize()">
                                <option value="200">200条</option>
                                <option value="500">500条</option>
                                <option value="1000" selected>1000条</option>
                            </select>
                        </div>
                    </div>
                    <div class="pagination-controls">
                        <button class="btn btn-outline" id="firstPageBtn" onclick="goToPage(1)">
                            <i class="fas fa-angle-double-left"></i> 首页
                        </button>
                        <button class="btn btn-outline" id="prevPageBtn" onclick="previousPage()">
                            <i class="fas fa-angle-left"></i> 上一页
                        </button>
                        <div class="page-numbers" id="pageNumbers">
                            <!-- 页码通过JavaScript生成 -->
                        </div>
                        <button class="btn btn-outline" id="nextPageBtn" onclick="nextPage()">
                            下一页 <i class="fas fa-angle-right"></i>
                        </button>
                        <button class="btn btn-outline" id="lastPageBtn" onclick="goToPage(totalPages)">
                            末页 <i class="fas fa-angle-double-right"></i>
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- 添加邮件数据模态框 -->
    <div id="addMailDataModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-plus"></i> 添加邮件数据</h3>
                <span class="close" onclick="closeAddMailDataModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="addMailDataForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="addMailClass">邮件类型 <span class="required">*</span></label>
                            <select id="addMailClass" name="Mail_class" required>
                                <option value="">请选择邮件类型</option>
                                <option value="TY">TY</option>
                                <option value="PY">PY</option>
                            </select>
                            <small class="form-text text-muted">只能选择TY或PY</small>
                        </div>
                        <div class="form-group">
                            <label for="addReceptacleNo">总包号 <span class="required">*</span></label>
                            <input type="text" id="addReceptacleNo" name="mail_receptacleNo" required maxlength="29" placeholder="前15位字母+后14位数字，共29位">
                            <small class="form-text text-muted">格式：前15位字母+后14位数字，字母将自动转为大写</small>
                        </div>
                        <div class="form-group">
                            <label for="addOriginPost">始发局 <span class="required">*</span></label>
                            <input type="text" id="addOriginPost" name="mail_originPost" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="addDestPost">寄达局 <span class="required">*</span></label>
                            <input type="text" id="addDestPost" name="mail_destPost" required>
                        </div>
                        <div class="form-group">
                            <label for="addDest">到达地 <span class="required">*</span></label>
                            <input type="text" id="addDest" name="mail_dest" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="addRecTime">接收时间 <span class="required">*</span></label>
                            <input type="datetime-local" id="addRecTime" name="mail_recTime" required>
                        </div>
                        <div class="form-group">
                            <label for="addUpliftTime">启运时间 <span class="required">*</span></label>
                            <input type="datetime-local" id="addUpliftTime" name="mail_upliftTime" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="addArriveTime">到达时间 <span class="required">*</span></label>
                            <input type="datetime-local" id="addArriveTime" name="mail_arriveTime" required>
                        </div>
                        <div class="form-group">
                            <label for="addDeliverTime">交邮时间 <span class="required">*</span></label>
                            <input type="datetime-local" id="addDeliverTime" name="mail_deliverTime" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="addRouteInfo">收费路由</label>
                            <input type="text" id="addRouteInfo" name="mail_routeInfo">
                        </div>
                        <div class="form-group">
                            <label for="addFlightInfo">航班</label>
                            <input type="text" id="addFlightInfo" name="mail_flightInfo">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="addWeight">重量</label>
                            <input type="number" id="addWeight" name="mail_weight" step="0.001" min="0">
                        </div>
                        <div class="form-group">
                            <label for="addQuote">费率</label>
                            <input type="number" id="addQuote" name="mail_quote" step="0.01" min="0">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="addCharge">金额</label>
                            <input type="number" id="addCharge" name="mail_charge" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label for="addCarrCode">运能编码</label>
                            <input type="text" id="addCarrCode" name="mail_carrCode">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeAddMailDataModal()">取消</button>
                <button type="button" class="btn btn-primary" onclick="addMailData()">确定</button>
            </div>
        </div>
    </div>

    <!-- Excel导入模态框 -->
    <div id="importExcelModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-file-excel"></i> Excel导入邮件数据</h3>
                <span class="close" onclick="closeImportExcelModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="import-instructions">
                    <h4>导入说明：</h4>
                    <ul>
                        <li>Excel文件必须包含以下字段：邮件类型、总包号、到达地、接收时间、启运时间、到达时间、交邮时间</li>
                        <li>邮件类型格式：只能是PY或TY</li>
                        <li>总包号格式：前15位字母+后14位数字，共29位</li>
                        <li>时间格式：YYYY-MM-DD HH:MM:SS</li>
                        <li>如果任何一条数据验证失败，整个导入将被取消</li>
                        <li>系统会自动填充收费路由、航班、费率、运能编码等信息</li>
                    </ul>
                </div>
                <div class="form-group">
                    <label for="excelFile">选择Excel文件 <span class="required">*</span></label>
                    <input type="file" id="excelFile" accept=".xlsx,.xls" required>
                    <small class="form-text text-muted">支持.xlsx和.xls格式</small>
                </div>
                <div id="importProgress" class="import-progress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill"></div>
                    </div>
                    <div class="progress-text">正在导入...</div>
                </div>
                <div id="importResult" class="import-result" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeImportExcelModal()">取消</button>
                <button type="button" class="btn btn-success" onclick="importExcelData()" id="importBtn">
                    <i class="fas fa-upload"></i> 开始导入
                </button>
            </div>
        </div>
    </div>

    <!-- 编辑邮件数据模态框 -->
    <div id="editMailDataModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> 编辑邮件数据</h3>
                <span class="close" onclick="closeEditMailDataModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editMailDataForm">
                    <input type="hidden" id="editMailId" name="mail_id">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editMailClass">邮件类型 <span class="required">*</span></label>
                            <select id="editMailClass" name="Mail_class" required>
                                <option value="">请选择邮件类型</option>
                                <option value="TY">TY</option>
                                <option value="PY">PY</option>
                            </select>
                            <small class="form-text text-muted">只能选择TY或PY</small>
                        </div>
                        <div class="form-group">
                            <label for="editReceptacleNo">总包号 <span class="required">*</span></label>
                            <input type="text" id="editReceptacleNo" name="mail_receptacleNo" required maxlength="29" placeholder="前15位字母+后14位数字，共29位">
                            <small class="form-text text-muted">格式：前15位字母+后14位数字，字母将自动转为大写</small>
                        </div>
                        <div class="form-group">
                            <label for="editOriginPost">始发局 <span class="required">*</span></label>
                            <input type="text" id="editOriginPost" name="mail_originPost" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editDestPost">寄达局 <span class="required">*</span></label>
                            <input type="text" id="editDestPost" name="mail_destPost" required>
                        </div>
                        <div class="form-group">
                            <label for="editDest">到达地 <span class="required">*</span></label>
                            <input type="text" id="editDest" name="mail_dest" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editRecTime">接收时间 <span class="required">*</span></label>
                            <input type="datetime-local" id="editRecTime" name="mail_recTime" required>
                        </div>
                        <div class="form-group">
                            <label for="editUpliftTime">启运时间 <span class="required">*</span></label>
                            <input type="datetime-local" id="editUpliftTime" name="mail_upliftTime" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editArriveTime">到达时间 <span class="required">*</span></label>
                            <input type="datetime-local" id="editArriveTime" name="mail_arriveTime" required>
                        </div>
                        <div class="form-group">
                            <label for="editDeliverTime">交邮时间 <span class="required">*</span></label>
                            <input type="datetime-local" id="editDeliverTime" name="mail_deliverTime" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editRouteInfo">收费路由</label>
                            <input type="text" id="editRouteInfo" name="mail_routeInfo">
                        </div>
                        <div class="form-group">
                            <label for="editFlightInfo">航班</label>
                            <input type="text" id="editFlightInfo" name="mail_flightInfo">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editWeight">重量</label>
                            <input type="number" id="editWeight" name="mail_weight" step="0.001" min="0">
                        </div>
                        <div class="form-group">
                            <label for="editQuote">费率</label>
                            <input type="number" id="editQuote" name="mail_quote" step="0.01" min="0">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editCharge">金额</label>
                            <input type="number" id="editCharge" name="mail_charge" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label for="editCarrCode">运能编码</label>
                            <input type="text" id="editCarrCode" name="mail_carrCode">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeEditMailDataModal()">取消</button>
                <button type="button" class="btn btn-primary" onclick="updateMailData()">确定</button>
            </div>
        </div>
    </div>

    <!-- 修改密码模态框 -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-key"></i> 修改密码</h3>
                <span class="close" onclick="closeChangePasswordModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="changePasswordForm">
                    <div class="form-group">
                        <label for="currentPassword">当前密码 <span class="required">*</span></label>
                        <input type="password" id="currentPassword" name="current_password" required>
                    </div>
                    <div class="form-group">
                        <label for="newPassword">新密码 <span class="required">*</span></label>
                        <input type="password" id="newPassword" name="new_password" required minlength="6">
                        <small class="form-text">密码长度至少6位</small>
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">确认新密码 <span class="required">*</span></label>
                        <input type="password" id="confirmPassword" name="confirm_password" required minlength="6">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeChangePasswordModal()">取消</button>
                <button type="button" class="btn btn-primary" onclick="changePassword()">确定</button>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentPage = 1;
        let totalPages = 1;
        let pageSize = 1000;
        let totalRecords = 0;
        let searchKeyword = '';

        // 搜索功能已移至文件前部

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // 检查菜单状态
                checkMenuState();
                // 加载邮件数据
                console.log('页面加载完成，开始加载邮件数据');
                loadMailData();
                // 设置总包号实时验证
                setupReceptacleNoValidation();
            } catch (error) {
                console.error('页面初始化错误:', error);
                alert('页面初始化失败: ' + error.message);
            }
        });

        // 检查菜单状态
        function checkMenuState() {
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            
            if (localStorage.getItem('sidebarCollapsed') === 'true') {
                sidebar.classList.add('collapsed');
                mainContent.classList.add('expanded');
            }
        }

        // 加载邮件数据
        function loadMailData(page = 1) {
            console.log('loadMailData called with page:', page);
            currentPage = page;
            
            const params = new URLSearchParams({
                page: page,
                per_page: pageSize
            });
            
            if (searchKeyword) {
                params.append('search', searchKeyword);
            }
            
            console.log('Fetching URL:', `/api/mail_data?${params}`);
            fetch(`/api/mail_data?${params}`)
                .then(response => {
                    console.log('Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('API response:', data);
                    if (data.success) {
                        console.log('Data received, count:', data.data ? data.data.length : 0);
                        updateMailDataDisplay(data.data);
                        updateMailDataPagination(data);
                    } else {
                        console.log('API error:', data.message);
                        // 如果是未登录错误，重定向到登录页面
                        if (data.message && data.message.includes('登录')) {
                            console.log('Redirecting to login');
                            window.location.href = '/login';
                            return;
                        }
                        showMessage('获取邮件数据失败: ' + data.message, 'error');
                        // 显示空数据状态
                        updateMailDataDisplay([]);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showMessage('网络错误，请稍后重试', 'error');
                    // 显示空数据状态
                    updateMailDataDisplay([]);
                });
        }

        // 更新邮件数据显示
        function updateMailDataDisplay(mailData) {
            const tbody = document.getElementById('mailDataTableBody');
            tbody.innerHTML = '';
            
            if (mailData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="18" class="text-center">暂无数据</td></tr>';
                return;
            }
            
            mailData.forEach((item, index) => {
                const row = document.createElement('tr');
                const serialNumber = (currentPage - 1) * pageSize + index + 1;
                
                row.innerHTML = `
                    <td><input type="checkbox" class="row-checkbox" value="${item.mail_id}" onchange="updateSelectAllState()"></td>
                    <td>${serialNumber}</td>
                    <td>${item.Mail_class || ''}</td>
                    <td>${item.mail_settle_code || ''}</td>
                    <td>${item.mail_receptacleNo || ''}</td>
                    <td>${item.mail_originPost || ''}</td>
                    <td>${item.mail_destPost || ''}</td>
                    <td>${item.mail_dest || ''}</td>
                    <td>${formatDateTime(item.mail_recTime)}</td>
                    <td>${formatDateTime(item.mail_upliftTime)}</td>
                    <td>${formatDateTime(item.mail_arriveTime)}</td>
                    <td>${formatDateTime(item.mail_deliverTime)}</td>
                    <td>${item.mail_routeInfo || ''}</td>
                    <td>${item.mail_flightInfo || ''}</td>
                    <td>${item.mail_weight ? parseFloat(item.mail_weight).toFixed(1) : ''}</td>
                    <td>${item.mail_quote || ''}</td>
                    <td>${item.mail_charge || ''}</td>
                    <td>${item.mail_carrCode || ''}</td>

                `;
                
                tbody.appendChild(row);
            });
            
            // 重置全选状态
            const selectAllCheckbox = document.getElementById('selectAll');
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            }
        }

        // 更新分页信息
        function updateMailDataPagination(data) {
            totalPages = data.total_pages;
            totalRecords = data.total;
            currentPage = data.page;
            
            // 更新分页信息显示
            const start = (currentPage - 1) * pageSize + 1;
            const end = Math.min(currentPage * pageSize, totalRecords);
            document.getElementById('paginationInfo').textContent = 
                `显示第 ${start}-${end} 条，共 ${totalRecords} 条记录`;
            
            // 更新按钮状态
            document.getElementById('firstPageBtn').disabled = currentPage === 1;
            document.getElementById('prevPageBtn').disabled = currentPage === 1;
            document.getElementById('nextPageBtn').disabled = currentPage === totalPages;
            document.getElementById('lastPageBtn').disabled = currentPage === totalPages;
            
            // 生成页码
            generatePageNumbers();
        }

        // 生成页码
        function generatePageNumbers() {
            const pageNumbers = document.getElementById('pageNumbers');
            pageNumbers.innerHTML = '';
            
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `btn ${i === currentPage ? 'btn-primary' : 'btn-outline'}`;
                pageBtn.textContent = i;
                pageBtn.onclick = () => goToPage(i);
                pageNumbers.appendChild(pageBtn);
            }
        }

        // 分页控制函数
        function goToPage(page) {
            if (page >= 1 && page <= totalPages && page !== currentPage) {
                loadMailData(page);
            }
        }

        function previousPage() {
            if (currentPage > 1) {
                loadMailData(currentPage - 1);
            }
        }

        function nextPage() {
            if (currentPage < totalPages) {
                loadMailData(currentPage + 1);
            }
        }

        // 改变每页显示条数
        function changePageSize() {
            pageSize = parseInt(document.getElementById('pageSizeSelect').value);
            loadMailData(1);
        }

        // 搜索功能
        function searchMailData() {
            // 获取所有搜索条件
            const receptacleNos = document.getElementById('receptacleNoInput').value.trim();
            const dests = document.getElementById('destInput').value.trim();
            const timeType = document.getElementById('timeTypeSelect').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            // 构建搜索参数
            const searchParams = {};
            if (receptacleNos) searchParams.receptacle_nos = receptacleNos;
            if (dests) searchParams.destinations = dests;
            if (timeType && startDate) {
                searchParams.time_type = timeType;
                searchParams.start_date = startDate;
                if (endDate) searchParams.end_date = endDate;
            }
            
            // 将搜索参数转换为字符串存储
            searchKeyword = JSON.stringify(searchParams);
            loadMailData(1);
        }

        function clearSearch() {
            document.getElementById('receptacleNoInput').value = '';
            document.getElementById('destInput').value = '';
            document.getElementById('timeTypeSelect').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            searchKeyword = '';
            loadMailData(1);
        }
        


        // 格式化日期时间
        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return '';
            
            // 处理YYYYMMDD格式的字符串，直接返回原格式
            if (typeof dateTimeStr === 'string' && dateTimeStr.length === 8 && /^\d{8}$/.test(dateTimeStr)) {
                return dateTimeStr;
            }
            
            // 处理标准日期时间格式，转换为YYYYMMDD格式
            const date = new Date(dateTimeStr);
            if (isNaN(date.getTime())) {
                return dateTimeStr; // 如果无法解析，返回原字符串
            }
            
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}${month}${day}`;
        }

        // 显示添加邮件数据模态框
        function showAddMailDataModal() {
            document.getElementById('addMailDataModal').style.display = 'block';
        }

        // 关闭添加邮件数据模态框
        function closeAddMailDataModal() {
            document.getElementById('addMailDataModal').style.display = 'none';
            document.getElementById('addMailDataForm').reset();
        }

        // 添加邮件数据
        // 验证邮件类型格式（与账单信息管理相同）
         function validateMailClass(mailClass) {
             if (!mailClass) {
                 return { isValid: false, message: '邮件类型不能为空' };
             }
             if (mailClass !== 'TY' && mailClass !== 'PY') {
                 return { isValid: false, message: '邮件类型只能是PY或TY' };
             }
             return { isValid: true, message: '' };
         }

        // 验证总包号格式
        function validateReceptacleNo(receptacleNo) {
            if (!receptacleNo) {
                return { valid: false, message: '总包号不能为空' };
            }
            
            if (receptacleNo.length !== 29) {
                return { valid: false, message: '总包号长度必须为29位' };
            }
            
            const letterPart = receptacleNo.substring(0, 15);
            const numberPart = receptacleNo.substring(15);
            
            // 检查前15位是否为字母
            if (!/^[A-Za-z]{15}$/.test(letterPart)) {
                return { valid: false, message: '总包号前15位必须为字母' };
            }
            
            // 检查后14位是否为数字
            if (!/^\d{14}$/.test(numberPart)) {
                return { valid: false, message: '总包号后14位必须为数字' };
            }
            
            return { valid: true, message: '' };
        }
        
        // 自动提取始发局和寄达局
        function autoExtractPostOffices(receptacleNo, isEdit = false) {
            if (receptacleNo && receptacleNo.length >= 12) {
                const originPost = receptacleNo.substring(0, 6); // 第1-6位
                const destPost = receptacleNo.substring(6, 12); // 第7-12位
                
                if (isEdit) {
                    document.getElementById('editOriginPost').value = originPost;
                    document.getElementById('editDestPost').value = destPost;
                } else {
                    document.getElementById('addOriginPost').value = originPost;
                    document.getElementById('addDestPost').value = destPost;
                }
            }
        }

        // 验证到达地是否存在于bill_info表
        async function validateDestination(destination) {
            if (!destination || destination.trim() === '') {
                return { isValid: false, message: '到达地不能为空' };
            }
            
            try {
                const response = await fetch('/api/validate_destination', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ destination: destination.trim() })
                });
                
                const result = await response.json();
                return { isValid: result.success, message: result.message };
            } catch (error) {
                return { isValid: false, message: '验证到达地时发生错误' };
            }
        }

        // 时间格式转换函数：将datetime-local格式转换为YYYYMMDD格式
        function convertDateTimeToYYYYMMDD(datetimeValue) {
            if (!datetimeValue) {
                return '';
            }
            
            // datetime-local格式: 2025-09-09T05:00
            const date = new Date(datetimeValue);
            
            if (isNaN(date.getTime())) {
                return '';
            }
            
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            
            return `${year}${month}${day}`;
        }

        // 将YYYYMMDD格式转换为datetime-local格式
        function convertYYYYMMDDToDateTime(yyyymmdd) {
            if (!yyyymmdd || yyyymmdd.length !== 8) {
                return '';
            }
            
            const year = yyyymmdd.substring(0, 4);
            const month = yyyymmdd.substring(4, 6);
            const day = yyyymmdd.substring(6, 8);
            
            // 返回格式: 2025-09-09T00:00
            return `${year}-${month}-${day}T00:00`;
        }

        // 通过到达地获取账单信息并自动填充相关字段
        async function autoFillBillInfo(destination, isEdit = false) {
            if (!destination || destination.trim() === '') {
                return;
            }
            
            // 获取当前选择的邮件类型
            const prefix = isEdit ? 'edit' : 'add';
            const mailClassElement = document.getElementById(`${prefix}MailClass`);
            const mailClass = mailClassElement ? mailClassElement.value : '';
            
            try {
                const response = await fetch('/api/get_bill_info_by_destination', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        destination: destination.trim(),
                        mail_class: mailClass
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    const prefix = isEdit ? 'edit' : 'add';
                    
                    // 自动填充字段
                    document.getElementById(`${prefix}RouteInfo`).value = result.data.route_info || '';
                    document.getElementById(`${prefix}FlightInfo`).value = result.data.flight_no || '';
                    document.getElementById(`${prefix}Quote`).value = result.data.quote || '';
                    document.getElementById(`${prefix}CarrCode`).value = result.data.carr_code || '';
                    
                    // 触发费率变化事件，重新计算金额
                    const quoteInput = document.getElementById(`${prefix}Quote`);
                    if (quoteInput) {
                        quoteInput.dispatchEvent(new Event('input'));
                    }
                }
            } catch (error) {
                console.error('获取账单信息失败:', error);
            }
        }

        // 根据总包号计算重量（最后3位数字除以10）
        function calculateWeight(receptacleNo) {
            if (!receptacleNo || receptacleNo.length < 3) {
                return '';
            }
            
            // 获取总包号最后3位数字
            const lastThreeDigits = receptacleNo.slice(-3);
            
            // 检查是否为数字
            if (!/^\d{3}$/.test(lastThreeDigits)) {
                return '';
            }
            
            // 除以10并保留1位小数
            const weight = parseInt(lastThreeDigits) / 10;
            return weight.toFixed(1);
        }

        // 计算金额（重量 * 费率）
        function calculateCharge(weight, quote) {
            const weightNum = parseFloat(weight) || 0;
            const quoteNum = parseFloat(quote) || 0;
            
            if (weightNum === 0 || quoteNum === 0) {
                return '';
            }
            
            const charge = weightNum * quoteNum;
            return charge.toFixed(2);
        }

        // 实时验证总包号输入并自动提取始发局和寄达局
        function setupReceptacleNoValidation() {
            const addInput = document.getElementById('addReceptacleNo');
            const editInput = document.getElementById('editReceptacleNo');
            
            function validateInput(input, isEdit = false) {
                const value = input.value;
                const validation = validateReceptacleNo(value);
                
                // 移除之前的验证样式
                input.classList.remove('is-valid', 'is-invalid');
                
                if (value.length === 0) {
                    return; // 空值时不显示验证状态
                }
                
                if (validation.isValid) {
                    input.classList.add('is-valid');
                    // 自动提取始发局和寄达局
                    autoExtractPostOffices(value, isEdit);
                } else {
                    input.classList.add('is-invalid');
                }
            }
            
            if (addInput) {
                addInput.addEventListener('input', function() {
                    validateInput(this, false);
                    // 自动计算重量
                    const weight = calculateWeight(this.value);
                    document.getElementById('addWeight').value = weight;
                    // 重新计算金额
                    const quote = document.getElementById('addQuote').value;
                    const charge = calculateCharge(weight, quote);
                    document.getElementById('addCharge').value = charge;
                });
            }
            
            if (editInput) {
                editInput.addEventListener('input', function() {
                    validateInput(this, true);
                    // 自动计算重量
                    const weight = calculateWeight(this.value);
                    document.getElementById('editWeight').value = weight;
                    // 重新计算金额
                    const quote = document.getElementById('editQuote').value;
                    const charge = calculateCharge(weight, quote);
                    document.getElementById('editCharge').value = charge;
                });
            }
        }

        async function addMailData() {
            const form = document.getElementById('addMailDataForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            // 验证必填字段（包括时间字段）
            if (!data.Mail_class || !data.mail_receptacleNo || !data.mail_originPost || !data.mail_destPost || !data.mail_dest || 
                !data.mail_recTime || !data.mail_upliftTime || !data.mail_arriveTime || !data.mail_deliverTime) {
                showMessage('请填写所有必填字段', 'error');
                return;
            }
            
            // 验证邮件类型格式
            const mailClassValidation = validateMailClass(data.Mail_class);
            if (!mailClassValidation.isValid) {
                showMessage(mailClassValidation.message, 'error');
                return;
            }
            
            // 将邮件类型转换为大写
            data.Mail_class = data.Mail_class.toUpperCase();
            
            // 验证总包号格式
            const receptacleValidation = validateReceptacleNo(data.mail_receptacleNo);
            if (!receptacleValidation.isValid) {
                showMessage(receptacleValidation.message, 'error');
                return;
            }
            
            // 将总包号前15位转换为大写
            data.mail_receptacleNo = data.mail_receptacleNo.substring(0, 15).toUpperCase() + data.mail_receptacleNo.substring(15);
            
            // 验证到达地是否存在
            const destValidation = await validateDestination(data.mail_dest);
            if (!destValidation.isValid) {
                showMessage(destValidation.message, 'error');
                return;
            }
            
            // 转换时间格式为YYYYMMDD
            data.mail_recTime = convertDateTimeToYYYYMMDD(data.mail_recTime);
            data.mail_upliftTime = convertDateTimeToYYYYMMDD(data.mail_upliftTime);
            data.mail_arriveTime = convertDateTimeToYYYYMMDD(data.mail_arriveTime);
            data.mail_deliverTime = convertDateTimeToYYYYMMDD(data.mail_deliverTime);
            
            fetch('/api/mail_data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showMessage(result.message, 'success');
                    closeAddMailDataModal();
                    loadMailData(currentPage);
                } else {
                    showMessage(result.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('网络错误，请稍后重试', 'error');
            });
        }

        // 编辑邮件数据
        function editMailData(mailId) {
            // 获取邮件数据详情
            fetch(`/api/mail_data?page=1&per_page=1000`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const mailData = data.data.find(item => item.mail_id === mailId);
                        if (mailData) {
                            // 填充编辑表单
                            document.getElementById('editMailId').value = mailData.mail_id;
                            document.getElementById('editMailClass').value = mailData.Mail_class || '';
                            document.getElementById('editReceptacleNo').value = mailData.mail_receptacleNo || '';
                            document.getElementById('editOriginPost').value = mailData.mail_originPost || '';
                            document.getElementById('editDestPost').value = mailData.mail_destPost || '';
                            document.getElementById('editDest').value = mailData.mail_dest || '';
                            document.getElementById('editRecTime').value = convertYYYYMMDDToDateTime(mailData.mail_recTime);
                            document.getElementById('editUpliftTime').value = convertYYYYMMDDToDateTime(mailData.mail_upliftTime);
                            document.getElementById('editArriveTime').value = convertYYYYMMDDToDateTime(mailData.mail_arriveTime);
                            document.getElementById('editDeliverTime').value = convertYYYYMMDDToDateTime(mailData.mail_deliverTime);
                            document.getElementById('editRouteInfo').value = mailData.mail_routeInfo || '';
                            document.getElementById('editFlightInfo').value = mailData.mail_flightInfo || '';
                            document.getElementById('editWeight').value = mailData.mail_weight || '';
                            document.getElementById('editQuote').value = mailData.mail_quote || '';
                            document.getElementById('editCharge').value = mailData.mail_charge || '';
                            document.getElementById('editCarrCode').value = mailData.mail_carrCode || '';
                            
                            // 显示编辑模态框
                            document.getElementById('editMailDataModal').style.display = 'block';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showMessage('获取邮件数据失败', 'error');
                });
        }

        // 关闭编辑邮件数据模态框
        function closeEditMailDataModal() {
            document.getElementById('editMailDataModal').style.display = 'none';
            document.getElementById('editMailDataForm').reset();
        }

        // 更新邮件数据
        async function updateMailData() {
            const form = document.getElementById('editMailDataForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            const mailId = data.mail_id;
            
            // 验证必填字段（包括时间字段）
            if (!data.Mail_class || !data.mail_receptacleNo || !data.mail_originPost || !data.mail_destPost || !data.mail_dest ||
                !data.mail_recTime || !data.mail_upliftTime || !data.mail_arriveTime || !data.mail_deliverTime) {
                showMessage('请填写所有必填字段', 'error');
                return;
            }
            
            // 验证邮件类型格式
            const mailClassValidation = validateMailClass(data.Mail_class);
            if (!mailClassValidation.isValid) {
                showMessage(mailClassValidation.message, 'error');
                return;
            }
            
            // 将邮件类型转换为大写
            data.Mail_class = data.Mail_class.toUpperCase();
            
            // 验证总包号格式
            const receptacleValidation = validateReceptacleNo(data.mail_receptacleNo);
            if (!receptacleValidation.isValid) {
                showMessage(receptacleValidation.message, 'error');
                return;
            }
            
            // 将总包号前15位转换为大写
            data.mail_receptacleNo = data.mail_receptacleNo.substring(0, 15).toUpperCase() + data.mail_receptacleNo.substring(15);
            
            // 验证到达地是否存在
            const destValidation = await validateDestination(data.mail_dest);
            if (!destValidation.isValid) {
                showMessage(destValidation.message, 'error');
                return;
            }
            
            // 转换时间格式为YYYYMMDD
            data.mail_recTime = convertDateTimeToYYYYMMDD(data.mail_recTime);
            data.mail_upliftTime = convertDateTimeToYYYYMMDD(data.mail_upliftTime);
            data.mail_arriveTime = convertDateTimeToYYYYMMDD(data.mail_arriveTime);
            data.mail_deliverTime = convertDateTimeToYYYYMMDD(data.mail_deliverTime);
            
            fetch(`/api/mail_data/${mailId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showMessage(result.message, 'success');
                    closeEditMailDataModal();
                    loadMailData(currentPage);
                } else {
                    showMessage(result.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('网络错误，请稍后重试', 'error');
            });
        }

        // 删除邮件数据
        function deleteMailData(mailId) {
            if (confirm('确定要删除这条邮件数据吗？此操作不可恢复。')) {
                fetch(`/api/mail_data/${mailId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        showMessage(result.message, 'success');
                        loadMailData(currentPage);
                    } else {
                        showMessage(result.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showMessage('网络错误，请稍后重试', 'error');
                });
            }
        }

        // 格式化日期时间为输入框格式
        function formatDateTimeForInput(dateTimeStr) {
            if (!dateTimeStr) return '';
            const date = new Date(dateTimeStr);
            return date.toISOString().slice(0, 16);
        }

        // 显示修改密码模态框
        function showChangePasswordModal() {
            document.getElementById('changePasswordModal').style.display = 'block';
        }

        // 关闭修改密码模态框
        function closeChangePasswordModal() {
            document.getElementById('changePasswordModal').style.display = 'none';
            document.getElementById('changePasswordForm').reset();
        }

        // 修改密码
        function changePassword() {
            const form = document.getElementById('changePasswordForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            // 验证新密码和确认密码是否一致
            if (data.new_password !== data.confirm_password) {
                showMessage('新密码和确认密码不一致', 'error');
                return;
            }
            
            // 验证密码长度
            if (data.new_password.length < 6) {
                showMessage('新密码长度至少6位', 'error');
                return;
            }
            
            fetch('/change_password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    current_password: data.current_password,
                    new_password: data.new_password
                })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showMessage(result.message, 'success');
                    closeChangePasswordModal();
                } else {
                    showMessage(result.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('网络错误，请稍后重试', 'error');
            });
        }

        // 子菜单切换功能
        function toggleSubmenu(element) {
            const submenu = element.nextElementSibling;
            const arrow = element.querySelector('.submenu-arrow');
            const parentLi = element.parentElement;
            
            // 切换子菜单显示状态
            if (submenu.style.maxHeight && submenu.style.maxHeight !== '0px') {
                submenu.style.maxHeight = '0px';
                arrow.style.transform = 'rotate(0deg)';
                parentLi.classList.remove('active');
            } else {
                // 先关闭其他子菜单
                document.querySelectorAll('.submenu').forEach(menu => {
                    menu.style.maxHeight = '0px';
                });
                document.querySelectorAll('.submenu-arrow').forEach(arr => {
                    arr.style.transform = 'rotate(0deg)';
                });
                document.querySelectorAll('.has-submenu').forEach(item => {
                    item.classList.remove('active');
                });
                
                // 显示当前子菜单
                submenu.style.maxHeight = submenu.scrollHeight + 'px';
                arrow.style.transform = 'rotate(90deg)';
                parentLi.classList.add('active');
            }
        }

        // 显示消息
        function showMessage(message, type = 'info') {
            // 创建消息元素
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${type}`;
            messageDiv.textContent = message;
            
            // 添加到页面
            document.body.appendChild(messageDiv);
            
            // 显示动画
            setTimeout(() => {
                messageDiv.classList.add('show');
            }, 100);
            
            // 自动隐藏
            setTimeout(() => {
                messageDiv.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(messageDiv);
                }, 300);
            }, 3000);
        }

        // Excel导入相关函数
        function showImportExcelModal() {
            document.getElementById('importExcelModal').style.display = 'block';
        }

        function closeImportExcelModal() {
            document.getElementById('importExcelModal').style.display = 'none';
            document.getElementById('excelFile').value = '';
            document.getElementById('importProgress').style.display = 'none';
            document.getElementById('importResult').style.display = 'none';
        }

        function importExcelData() {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showMessage('请选择Excel文件', 'error');
                return;
            }
            
            // 检查文件类型
            const allowedTypes = ['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'application/vnd.ms-excel'];
            if (!allowedTypes.includes(file.type)) {
                showMessage('请选择有效的Excel文件(.xlsx或.xls)', 'error');
                return;
            }
            
            // 显示进度条
            document.getElementById('importProgress').style.display = 'block';
            document.getElementById('importResult').style.display = 'none';
            document.getElementById('importBtn').disabled = true;
            
            // 初始化进度条
            const progressFill = document.querySelector('.progress-fill');
            const progressText = document.querySelector('.progress-text');
            progressFill.style.width = '0%';
            progressText.textContent = '正在准备导入...';
            
            let taskId = null;
            let progressInterval = null;
            
            // 创建FormData对象
            const formData = new FormData();
            formData.append('excel_file', file);
            
            // 发送请求
            fetch('/api/import_excel_mail_data', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.task_id) {
                    taskId = data.task_id;
                    // 开始查询进度
                    startProgressPolling();
                } else {
                    // 如果没有task_id，说明立即失败了
                    handleImportComplete(data);
                }
            })
            .catch(error => {
                console.error('导入请求失败:', error);
                progressText.textContent = '导入请求失败';
                document.getElementById('importBtn').disabled = false;
            });
            
            // 进度查询函数
            function startProgressPolling() {
                progressInterval = setInterval(() => {
                    fetch(`/api/import_progress/${taskId}`)
                    .then(response => response.json())
                    .then(progressData => {
                        if (progressData.status === 'completed' || progressData.status === 'error') {
                            clearInterval(progressInterval);
                            handleImportComplete(progressData);
                        } else {
                            updateProgress(progressData);
                        }
                    })
                    .catch(error => {
                        console.error('进度查询失败:', error);
                    });
                }, 1000); // 每秒查询一次
            }
            
            // 更新进度显示
            function updateProgress(progressData) {
                const { current = 0, total = 100, message = '处理中...' } = progressData;
                const progressPercent = total > 0 ? (current / total) * 100 : 0;
                progressFill.style.width = Math.min(progressPercent, 95) + '%'; // 最多显示95%，完成时显示100%
                progressText.textContent = message;
            }
            
            // 处理导入完成
            function handleImportComplete(data) {
                // 完成进度条
                progressFill.style.width = '100%';
                if (data.status === 'completed' && data.imported_count) {
                    progressText.textContent = `导入完成！共处理 ${data.imported_count} 条数据`;
                } else if (data.status === 'error') {
                    progressText.textContent = data.message || '导入失败';
                } else {
                    progressText.textContent = '处理完成！';
                }
                
                setTimeout(() => {
                    document.getElementById('importProgress').style.display = 'none';
                }, 1000);
                
                document.getElementById('importBtn').disabled = false;
                
                if (data.status === 'completed' || data.success) {
                    const importedCount = data.imported_count || 0;
                    document.getElementById('importResult').innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i>
                            <strong>导入成功！</strong><br>
                            成功导入 ${importedCount} 条记录
                        </div>
                    `;
                    document.getElementById('importResult').style.display = 'block';
                    
                    // 刷新数据列表
                    setTimeout(() => {
                        closeImportExcelModal();
                        loadMailData(1);
                        showMessage('Excel导入成功', 'success');
                    }, 2000);
                } else {
                    let errorHtml = `
                        <div class="alert alert-error">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>导入失败！</strong><br>
                            ${data.message}
                    `;
                    
                    // 检查是否有详细错误信息
                     const errors = data.errors || [];
                     if (errors.length > 0) {
                         errorHtml += '<br><br><strong style="color: #721c24;">详细错误信息：</strong>';
                         errorHtml += '<div style="max-height: 300px; overflow-y: auto; margin-top: 10px; background-color: #fff; border: 1px solid #f5c6cb; border-radius: 4px; padding: 10px;">';
                         errorHtml += '<ul style="margin: 0; padding-left: 20px; list-style-type: disc;">';
                         errors.forEach(error => {
                             errorHtml += `<li style="margin-bottom: 8px; line-height: 1.4; color: #721c24;"><strong>第${error.row}行:</strong> ${error.message}</li>`;
                         });
                         errorHtml += '</ul></div>';
                         
                         if (errors.length > 10) {
                             errorHtml += `<p style="margin-top: 10px; color: #856404; font-size: 12px; font-style: italic; background-color: #fff3cd; padding: 5px; border-radius: 3px; border: 1px solid #ffeaa7;">💡 显示了前${Math.min(errors.length, 50)}个错误，共发现${errors.length}个错误。建议先修复这些问题后重新导入。</p>`;
                         }
                     } else {
                         errorHtml += '<br><br><div style="background-color: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 10px; border-radius: 4px; margin-top: 10px;"><em>⚠️ 未获取到详细错误信息，请检查Excel文件格式是否正确，确保包含所有必需字段。</em></div>';
                     }
                    
                    errorHtml += '</div>';
                    document.getElementById('importResult').innerHTML = errorHtml;
                    document.getElementById('importResult').style.display = 'block';
                }
            }
        }

        // 用户下拉菜单交互
        // 用户下拉菜单功能
        const userDropdown = document.querySelector('.user-dropdown');
        const userButton = document.querySelector('.user-button');
        const dropdownContent = document.querySelector('.dropdown-content');
        
        if (userDropdown && userButton && dropdownContent) {
            let isDropdownOpen = false;
            
            // 点击用户按钮切换下拉菜单
            userButton.addEventListener('click', function(e) {
                e.stopPropagation();
                isDropdownOpen = !isDropdownOpen;
                dropdownContent.classList.toggle('show', isDropdownOpen);
            });
            
            // 悬停显示下拉菜单
            userDropdown.addEventListener('mouseenter', function() {
                if (!isDropdownOpen) {
                    isDropdownOpen = true;
                    dropdownContent.classList.add('show');
                }
            });
            
            // 鼠标进入下拉内容时保持显示
            dropdownContent.addEventListener('mouseenter', function() {
                // 保持显示状态
            });
            
            // 鼠标离开用户区域时隐藏（延迟处理以允许鼠标移动到下拉内容）
            userDropdown.addEventListener('mouseleave', function(e) {
                // 检查鼠标是否移动到下拉内容区域
                setTimeout(() => {
                    if (!userDropdown.matches(':hover') && !dropdownContent.matches(':hover')) {
                        isDropdownOpen = false;
                        dropdownContent.classList.remove('show');
                    }
                }, 100);
            });
            
            // 鼠标离开下拉内容时隐藏
            dropdownContent.addEventListener('mouseleave', function() {
                setTimeout(() => {
                    if (!userDropdown.matches(':hover') && !dropdownContent.matches(':hover')) {
                        isDropdownOpen = false;
                        dropdownContent.classList.remove('show');
                    }
                }, 100);
            });
            
            // 点击页面其他地方时隐藏下拉菜单
            document.addEventListener('click', function(e) {
                if (!userDropdown.contains(e.target)) {
                    isDropdownOpen = false;
                    dropdownContent.classList.remove('show');
                }
            });
            
            // 设置自动填充和计算功能的事件监听器
            setupAutoFillListeners();
        }
        
        // 设置到达地和费率字段的事件监听器
        function setupAutoFillListeners() {
            // 添加表单的到达地字段
            const addDestInput = document.getElementById('addDest');
            if (addDestInput) {
                addDestInput.addEventListener('blur', function() {
                    autoFillBillInfo(this.value, false);
                });
            }
            
            // 编辑表单的到达地字段
            const editDestInput = document.getElementById('editDest');
            if (editDestInput) {
                editDestInput.addEventListener('blur', function() {
                    autoFillBillInfo(this.value, true);
                });
            }
            
            // 添加表单的邮件类型字段
            const addMailClassInput = document.getElementById('addMailClass');
            if (addMailClassInput) {
                addMailClassInput.addEventListener('change', function() {
                    const destination = document.getElementById('addDest').value;
                    if (destination && destination.trim() !== '') {
                        autoFillBillInfo(destination, false);
                    }
                });
            }
            
            // 编辑表单的邮件类型字段
            const editMailClassInput = document.getElementById('editMailClass');
            if (editMailClassInput) {
                editMailClassInput.addEventListener('change', function() {
                    const destination = document.getElementById('editDest').value;
                    if (destination && destination.trim() !== '') {
                        autoFillBillInfo(destination, true);
                    }
                });
            }
            
            // 添加表单的费率字段
            const addQuoteInput = document.getElementById('addQuote');
            if (addQuoteInput) {
                addQuoteInput.addEventListener('input', function() {
                    const weight = document.getElementById('addWeight').value;
                    const charge = calculateCharge(weight, this.value);
                    document.getElementById('addCharge').value = charge;
                });
            }
            
            // 编辑表单的费率字段
            const editQuoteInput = document.getElementById('editQuote');
            if (editQuoteInput) {
                editQuoteInput.addEventListener('input', function() {
                    const weight = document.getElementById('editWeight').value;
                    const charge = calculateCharge(weight, this.value);
                    document.getElementById('editCharge').value = charge;
                });
            }
            
            // 添加表单的重量字段
            const addWeightInput = document.getElementById('addWeight');
            if (addWeightInput) {
                addWeightInput.addEventListener('input', function() {
                    const quote = document.getElementById('addQuote').value;
                    const charge = calculateCharge(this.value, quote);
                    document.getElementById('addCharge').value = charge;
                });
            }
            
            // 编辑表单的重量字段
            const editWeightInput = document.getElementById('editWeight');
            if (editWeightInput) {
                editWeightInput.addEventListener('input', function() {
                    const quote = document.getElementById('editQuote').value;
                    const charge = calculateCharge(this.value, quote);
                    document.getElementById('editCharge').value = charge;
                });
            }
        }

        // 全选/取消全选功能
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const rowCheckboxes = document.querySelectorAll('.row-checkbox');
            
            rowCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        }
        
        // 更新全选状态
        function updateSelectAllState() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const rowCheckboxes = document.querySelectorAll('.row-checkbox');
            const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
            
            if (checkedBoxes.length === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (checkedBoxes.length === rowCheckboxes.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            }
        }
        
        // 获取选中的行ID
        function getSelectedRowIds() {
            const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
            return Array.from(checkedBoxes).map(checkbox => checkbox.value);
        }

        // 删除选中的行
        async function deleteSelectedRows() {
            const selectedIds = getSelectedRowIds();
            
            if (selectedIds.length === 0) {
                showMessage('请先选择要删除的数据', 'warning');
                return;
            }
            
            // 确认删除弹窗
            const confirmDelete = confirm(`确定要删除选中的 ${selectedIds.length} 条数据吗？此操作不可撤销！`);
            if (!confirmDelete) {
                return;
            }
            
            try {
                const response = await fetch('/api/delete_mail_data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ids: selectedIds
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(`成功删除 ${selectedIds.length} 条数据`, 'success');
                    // 重新加载数据
                    loadMailData(currentPage);
                } else {
                    showMessage('删除失败: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('删除数据时发生错误:', error);
                showMessage('删除失败: 网络错误', 'error');
            }
        }

        // 点击模态框外部关闭
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
    </script>



</body>
</html>