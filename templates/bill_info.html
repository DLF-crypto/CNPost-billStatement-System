<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>账单信息管理 - 中邮账单管理系统</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- 头部导航 -->
        <header class="dashboard-header">
            <div class="header-left"></div>
            
            <div class="header-center">
                <h1>
                    <i class="fas fa-file-invoice-dollar"></i>
                    中邮账单管理系统
                    <small style="display: block; font-size: 14px; font-weight: 300; margin-top: 5px;">China Post Bill Management System</small>
                </h1>
            </div>
            
            <div class="header-right">
                <div class="user-info">
                    <div class="user-dropdown">
                        <div class="user-button">
                            <i class="fas fa-user-circle"></i>
                            <span>{{ username }}</span>
                        </div>
                        <div class="dropdown-content">
                            <a href="#" onclick="showChangePasswordModal(); event.stopPropagation(); return false;">
                                <i class="fas fa-key"></i>
                                修改密码
                            </a>
                            <a href="{{ url_for('logout') }}">
                                <i class="fas fa-sign-out-alt"></i>
                                退出登录
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- 主要布局容器 -->
        <div class="main-container">
            <!-- 左侧菜单栏 -->
            <aside class="sidebar">
                <nav class="sidebar-nav">
                    <ul class="nav-menu">
                        {% if 'dashboard' in permissions %}
                        <li class="nav-item">
                            <a href="{{ url_for('dashboard') }}" class="nav-link">
                                <i class="fas fa-tachometer-alt"></i>
                                <span>仪表盘</span>
                            </a>
                        </li>
                        {% endif %}
                        
                        {% if 'employees' in permissions or 'roles' in permissions %}
                        <li class="nav-item has-submenu active">
                            <a href="#" class="nav-link" onclick="toggleSubmenu(this)">
                                <i class="fas fa-database"></i>
                                <span>基础资料管理</span>
                                <i class="fas fa-chevron-right submenu-arrow"></i>
                            </a>
                            <ul class="submenu" style="display: block;">
                                {% if 'employees' in permissions %}
                                <li><a href="{{ url_for('employees') }}" class="submenu-link"><i class="fas fa-users"></i>员工管理</a></li>
                                {% endif %}
                                {% if 'roles' in permissions %}
                                <li><a href="{{ url_for('roles') }}" class="submenu-link"><i class="fas fa-user-tag"></i>角色管理</a></li>
                                {% endif %}
                                <li><a href="{{ url_for('bill_info') }}" class="submenu-link active"><i class="fas fa-file-invoice"></i>账单信息管理</a></li>
                            </ul>
                        </li>
                        {% endif %}
                        
                        {% if 'mail_data' in permissions %}
                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="fas fa-envelope-open-text"></i>
                                <span>邮件数据管理</span>
                            </a>
                        </li>
                        {% endif %}
                        
                        {% if 'bill_management' in permissions %}
                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="fas fa-calculator"></i>
                                <span>账单管理</span>
                            </a>
                        </li>
                        {% endif %}
                        
                        {% if 'reports' in permissions %}
                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="fas fa-chart-bar"></i>
                                <span>分析报表</span>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
            </aside>

            <!-- 主要内容 -->
            <main class="main-content">
                <!-- 显示消息 -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category }}">
                                <i class="fas fa-{{ 'check-circle' if category == 'success' else 'exclamation-triangle' if category == 'error' else 'info-circle' }}"></i>
                                {{ message }}
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
                
                <div class="content-header">
                    <h2><i class="fas fa-file-invoice"></i>账单信息管理</h2>
                    <div class="header-actions">
                        <button class="btn btn-success" onclick="showImportModal()">
                            <i class="fas fa-file-excel"></i>
                            导入Excel
                        </button>
                        <button class="btn btn-primary" onclick="showAddBillModal()">
                            <i class="fas fa-plus"></i>
                            添加账单信息
                        </button>
                    </div>
                </div>

                <!-- 账单信息列表 -->
                <div class="bill-list">
                    <div class="table-container">
                        <table class="bill-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>邮件类型</th>
                                    <th>目的地</th>
                                    <th>路由信息</th>
                                    <th>航班信息</th>
                                    <th>报价</th>
                                    <th>运能编码</th>
                                    <th>创建时间</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="billTableBody">
                                {% for bill in bill_info %}
                                <tr>
                                    <td>{{ bill.id }}</td>
                                    <td>{{ bill.mail_class }}</td>
                                    <td>{{ bill.des }}</td>
                                    <td>{{ bill.route_info or '-' }}</td>
                                    <td>{{ bill.flight_no or '-' }}</td>
                                    <td>{{ '%.2f'|format(bill.quote) if bill.quote else '-' }}</td>
                                    <td>{{ bill.carry_code or '-' }}</td>
                                    <td>{{ bill.created_at.strftime('%Y-%m-%d %H:%M') if bill.created_at else '' }}</td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="btn btn-sm btn-edit" onclick="editBill({{ bill.id }})">
                                                <i class="fas fa-edit"></i>
                                                编辑
                                            </button>
                                            <button class="btn btn-sm btn-delete" onclick="deleteBill({{ bill.id }})">
                                                <i class="fas fa-trash"></i>
                                                删除
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- 添加账单信息模态框 -->
    <div id="addBillModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-plus"></i>添加账单信息</h3>
                <span class="close" onclick="closeModal('addBillModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="addBillForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="mailClass">邮件类型 <span class="required">*</span></label>
                            <input type="text" id="mailClass" name="mail_class" required>
                        </div>
                        <div class="form-group">
                            <label for="des">目的地 <span class="required">*</span></label>
                            <input type="text" id="des" name="des" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="routeInfo">路由信息</label>
                            <input type="text" id="routeInfo" name="route_info">
                        </div>
                        <div class="form-group">
                            <label for="flightNo">航班信息</label>
                            <input type="text" id="flightNo" name="flight_no">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="quote">报价</label>
                            <input type="number" id="quote" name="quote" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label for="carryCode">运能编码</label>
                            <input type="text" id="carryCode" name="carry_code">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('addBillModal')">取消</button>
                <button type="button" class="btn btn-primary" onclick="addBill()">添加</button>
            </div>
        </div>
    </div>

    <!-- 编辑账单信息模态框 -->
    <div id="editBillModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i>编辑账单信息</h3>
                <span class="close" onclick="closeModal('editBillModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editBillForm">
                    <input type="hidden" id="editBillId">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editMailClass">邮件类型 <span class="required">*</span></label>
                            <input type="text" id="editMailClass" name="mail_class" required>
                        </div>
                        <div class="form-group">
                            <label for="editDes">目的地 <span class="required">*</span></label>
                            <input type="text" id="editDes" name="des" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editRouteInfo">路由信息</label>
                            <input type="text" id="editRouteInfo" name="route_info">
                        </div>
                        <div class="form-group">
                            <label for="editFlightNo">航班信息</label>
                            <input type="text" id="editFlightNo" name="flight_no">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editQuote">报价</label>
                            <input type="number" id="editQuote" name="quote" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label for="editCarryCode">运能编码</label>
                            <input type="text" id="editCarryCode" name="carry_code">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('editBillModal')">取消</button>
                <button type="button" class="btn btn-primary" onclick="updateBill()">更新</button>
            </div>
        </div>
    </div>

    <!-- 导入Excel模态框 -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-file-excel"></i>导入Excel文件</h3>
                <span class="close" onclick="closeModal('importModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="import-info">
                    <p><i class="fas fa-info-circle"></i> 请选择包含账单信息的Excel文件</p>
                    <p>Excel文件应包含以下列：邮件类型、目的地、路由信息、航班信息、报价、运能编码</p>
                </div>
                <form id="importForm" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="excelFile">选择Excel文件 <span class="required">*</span></label>
                        <input type="file" id="excelFile" name="excel_file" accept=".xlsx,.xls" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('importModal')">取消</button>
                <button type="button" class="btn btn-success" onclick="importExcel()">导入</button>
            </div>
        </div>
    </div>

    <!-- 修改密码模态框 -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-key"></i>修改密码</h3>
                <span class="close" onclick="closeModal('changePasswordModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="changePasswordForm">
                    <div class="form-group">
                        <label for="currentPassword">当前密码</label>
                        <input type="password" id="currentPassword" name="currentPassword" required>
                    </div>
                    <div class="form-group">
                        <label for="newPassword">新密码</label>
                        <input type="password" id="newPassword" name="newPassword" required>
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">确认新密码</label>
                        <input type="password" id="confirmPassword" name="confirmPassword" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('changePasswordModal')">取消</button>
                <button type="button" class="btn btn-primary" onclick="changePassword()">确认修改</button>
            </div>
        </div>
    </div>

    <script>
        // 菜单展开/收起功能
        function toggleSubmenu(element) {
            const submenu = element.nextElementSibling;
            const arrow = element.querySelector('.submenu-arrow');
            
            if (submenu.style.maxHeight === '0px' || submenu.style.maxHeight === '') {
                submenu.style.maxHeight = submenu.scrollHeight + 'px';
                if (arrow) {
                    arrow.classList.remove('fa-chevron-right');
                    arrow.classList.add('fa-chevron-down');
                }
            } else {
                submenu.style.maxHeight = '0px';
                if (arrow) {
                    arrow.classList.remove('fa-chevron-down');
                    arrow.classList.add('fa-chevron-right');
                }
            }
        }

        // 显示添加账单信息模态框
        function showAddBillModal() {
            document.getElementById('addBillModal').style.display = 'block';
            document.getElementById('addBillForm').reset();
        }

        // 显示导入模态框
        function showImportModal() {
            document.getElementById('importModal').style.display = 'block';
            document.getElementById('importForm').reset();
        }

        // 显示修改密码模态框
        function showChangePasswordModal() {
            document.getElementById('changePasswordModal').style.display = 'block';
            document.getElementById('changePasswordForm').reset();
        }

        // 关闭模态框
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // 添加账单信息
        function addBill() {
            const form = document.getElementById('addBillForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            fetch('/add_bill_info', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert(result.message);
                    closeModal('addBillModal');
                    location.reload();
                } else {
                    alert('错误：' + result.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('操作失败，请稍后重试');
            });
        }

        // 编辑账单信息
        function editBill(billId) {
            // 从表格中获取账单信息
            const rows = document.querySelectorAll('#billTableBody tr');
            let targetRow = null;
            
            for (let row of rows) {
                if (row.cells[0].textContent.trim() === billId.toString()) {
                    targetRow = row;
                    break;
                }
            }
            
            if (targetRow) {
                fillEditForm(targetRow, billId);
            } else {
                alert('未找到账单信息');
            }
        }

        function fillEditForm(row, billId) {
            document.getElementById('editBillId').value = billId;
            document.getElementById('editMailClass').value = row.cells[1].textContent;
            document.getElementById('editDes').value = row.cells[2].textContent;
            document.getElementById('editRouteInfo').value = row.cells[3].textContent === '-' ? '' : row.cells[3].textContent;
            document.getElementById('editFlightNo').value = row.cells[4].textContent === '-' ? '' : row.cells[4].textContent;
            document.getElementById('editQuote').value = row.cells[5].textContent === '-' ? '' : row.cells[5].textContent;
            document.getElementById('editCarryCode').value = row.cells[6].textContent === '-' ? '' : row.cells[6].textContent;
            
            document.getElementById('editBillModal').style.display = 'block';
        }

        // 更新账单信息
        function updateBill() {
            const form = document.getElementById('editBillForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            data.id = document.getElementById('editBillId').value;

            fetch('/update_bill_info', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert(result.message);
                    closeModal('editBillModal');
                    location.reload();
                } else {
                    alert('错误：' + result.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('操作失败，请稍后重试');
            });
        }

        // 删除账单信息
        function deleteBill(billId) {
            if (confirm('确定要删除这条账单信息吗？此操作不可恢复！')) {
                fetch('/delete_bill_info', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({id: billId})
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        alert(result.message);
                        location.reload();
                    } else {
                        alert('错误：' + result.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('操作失败，请稍后重试');
                });
            }
        }

        // 导入Excel
        function importExcel() {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('请选择要导入的Excel文件');
                return;
            }
            
            const formData = new FormData();
            formData.append('excel_file', file);
            
            // 显示加载状态
            const importBtn = document.querySelector('#importModal .btn-success');
            const originalText = importBtn.innerHTML;
            importBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 导入中...';
            importBtn.disabled = true;
            
            fetch('/import_bill_excel', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert(result.message);
                    closeModal('importModal');
                    location.reload();
                } else {
                    alert('导入失败：' + result.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('导入失败，请稍后重试');
            })
            .finally(() => {
                // 恢复按钮状态
                importBtn.innerHTML = originalText;
                importBtn.disabled = false;
            });
        }

        // 修改密码
        function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                alert('新密码和确认密码不匹配');
                return;
            }
            
            fetch('/change_password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    current_password: currentPassword,
                    new_password: newPassword
                })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert(result.message);
                    closeModal('changePasswordModal');
                } else {
                    alert('错误：' + result.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('操作失败，请稍后重试');
            });
        }

        // 用户下拉菜单交互
        const userDropdown = document.querySelector('.user-dropdown');
        const userButton = document.querySelector('.user-button');
        const dropdownContent = document.querySelector('.dropdown-content');
        
        if (userDropdown && userButton && dropdownContent) {
            let isDropdownOpen = false;
            
            // 点击用户按钮切换下拉菜单
            userButton.addEventListener('click', function(e) {
                e.stopPropagation();
                isDropdownOpen = !isDropdownOpen;
                dropdownContent.classList.toggle('show', isDropdownOpen);
            });
            
            // 鼠标进入下拉菜单区域时保持显示
            userDropdown.addEventListener('mouseenter', function() {
                if (!isDropdownOpen) {
                    isDropdownOpen = true;
                    dropdownContent.classList.add('show');
                }
            });
            
            // 鼠标离开下拉菜单区域时隐藏
            userDropdown.addEventListener('mouseleave', function() {
                isDropdownOpen = false;
                dropdownContent.classList.remove('show');
            });
            
            // 点击页面其他地方时隐藏下拉菜单
            document.addEventListener('click', function() {
                isDropdownOpen = false;
                dropdownContent.classList.remove('show');
            });
        }
    </script>
</body>
</html>